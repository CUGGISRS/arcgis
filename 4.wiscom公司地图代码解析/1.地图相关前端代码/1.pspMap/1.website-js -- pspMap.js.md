

## 地图代码解析

```js
var pspMap = function () {
	// Map类包含用于存储，管理和覆盖2D和3D查看共同的图层的属性和方法
	// 通过MapView（用于以2D方式查看数据）
	// SceneView（用于以3D方式查看数据）进行渲染
    dojo.require("esri.map");
    // 配置库的全局属性
    dojo.require("esri.config");
    dojo.require("esri.geometry.Point");
    dojo.require("esri.geometry.webMercatorUtils");
    dojo.require("esri.graphic");
    dojo.require("esri.layers.GraphicsLayer");
    dojo.require("esri.symbols.PictureMarkerSymbol");
    dojo.require("esri.symbols.SimpleMarkerSymbol");
    dojo.require("esri.Color");
    dojo.require("esri/dijit/OverviewMap");

    esri.config.defaults.io.corsDetection = true;
    esri.config.defaults.map.panDuration = 100;
    esri.config.defaults.map.panRate = 1;
    esri.config.defaults.map.zoomDuration = 100;
    esri.config.defaults.zoomRate = 1;


    var map = null;//地图对象
    var streetLayer = null;//地图底图
    var ImgLayer = null;
    var nightLayer = null;

    var tollgateclusterLayer = null;
    var videoclusterLayer = null;


    /*
     * 图层数组
     * [1,2,3,4]
     * 卡口，视频，案件，警情
     *
     * 卡口类型[78,79,80,81,82]
     *  WIFI探针卡口,人脸卡口,治安卡口  ,交通卡口,其他
     * */
    var tollgateLayer = null;//卡口图层
    var videoLayer = null;//视频图层
    var caseInfoLayer = null;//案件图层
    var warnInfoLayer = null;//警情图层

    var positioningLayer = null;//定位图层

    var whetherTheLoading = true;

    //地图页面汇点使用数据
    var tollgateArr = [];
    var videoArr = [];
    var caseInfoArr = [];
    var warnInfoArr = [];

    //返回页面的数据
    var businessTollgateArr = [];
    var businessCameraArr = [];
    var businessCaseInfoArr = [];
    var businessWarnInfoArr = [];

    //定位样式，SimpleMarkerSymbol:点
    var arraySymbol = new esri.symbols.SimpleMarkerSymbol(
        {
            "color": new esri.Color([255, 0, 0]),
            "style": "Square",
            "type": "esriSMS",
            "xoffset": 0,
            "yoffset": 0
        }
    );

    // 查询SDE.PSP_APP_MAPMAINTAIN(该表数据库中暂时没有)数据库中的内容
    var urlcenterPoint = "/systemManage/mapMaintain/initCenter";
    //查所有点位 -- 对应数据库中PSP_DB_CAMERA表
    var urlcameraList = "/videoManage/camera/cameraList";
    // 卡口点位查询 -- 对应数据库中psp_db_tollgate表
    var urltollgateList = "/systemManage/tollgate/viewTollgateList";
    /*==============================================================*/
    // 对应数据库中psp_db_warnInfo表，该表暂无数据
    var urlWarnInfoList = "/systemManage/warnInfo/warnInfoManage";
    // 对应数据库中PSP_DB_CASEEVENTINFO表，该表暂无数据
    var urlCaseInfoList = "/caseCenter/caseManage/getCaseInfoList";
    //测量地图使用的
    var measureTool = null;
    var measureHanlder = null;
    var drawToolBar = null;//地图toollbar
    var _cPoint = null;//加载完地图后的中心节点
    var _defaultZoomLevel = 12;//默认层级
    var currentPageObject;
    var objectId;
    var drawEndHandler;
    var optionDefault={
        initCamera:true
    };
    /*==============================================================*/
    
    // 存储需要初始化的图层数据
    var displayTutzenData = {};
    
    // ??1
    var _initMap = function (mapElement, obj, Layer,option) {
        // esri/dijit/OverviewMap  OverviewMap: 用于创建鹰眼小部件
        // extras/ClusterLayer  ClusterLayer: 点聚合/聚簇
        // esri/layers/WebTiledLayer  WebTiledLayer: 提供了一种简单的方法来将非ArcGIS Server地图图块添加为地图的图层
        // extras/ArcGISWebTiledLayer  ArcGISTiledLayer: 切片图层的一种类型(个人理解)
        // esri/geometry/Extent  Extent: 边界框的最小和最大X坐标和Y坐标
        // esri/SpatialReference : 定义地图，图层或任务参数的空间参考
        // esri/layers/TileInfo  TileInfo: 包含有关ArcGISTiledMapServiceLayer的切片方案的信息。TileInfo没有构造函数
        // dojo/_base/array  arrayUtils: 提供了可能无法使用的本机Array函数的增强功能
        // esri/geometry/Point  Point: 由X坐标和Y坐标定义的位置。它可以是地图单位或屏幕单位。
        // esri/symbols/SimpleMarkerSymbol  SimpleMarkerSymbol: SimpleMarkerSymbol用于将点显示为简单形状，例如圆形。
        // esri/renderers/ClassBreaksRenderer  ClassBreaksRenderer: 类中断渲染器根据某些数字属性的值来符号化每个图形。
        // esri/symbols/SimpleLineSymbol  SimpleLineSymbol: 线符号用于在图形层上绘制线性特征。
        // esri/Color  Color: 以提供用于设置颜色的功能
        // esri/geometry/webMercatorUtils  webMercatorUtils: 将Web墨卡托坐标转换为地理坐标，反之亦然。
        require(["esri/dijit/OverviewMap",
                 "extras/ClusterLayer",
                 "esri/layers/WebTiledLayer", 
                 "extras/ArcGISWebTiledLayer",
                 "esri/geometry/Extent", 
                 "esri/SpatialReference",
                 "esri/layers/TileInfo",
                 "dojo/_base/array",
                 "esri/geometry/Point",
                 "esri/symbols/SimpleMarkerSymbol",
                 "esri/renderers/ClassBreaksRenderer",
                 "esri/symbols/SimpleLineSymbol",
                 "esri/Color",
                 "esri/geometry/webMercatorUtils"],
            function (OverviewMap,ClusterLayer,
                      WebTiledLayer, ArcGISTiledLayer,
                      Extent, SpatialReference, TileInfo,
                      arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,SimpleLineSymbol,Color,webMercatorUtils) {
            // 创建地图
            map = new esri.map(mapElement, {
                // Booleean类型，是否自动调整大小，true：地图自动调整大小
                autoResize: true,
                // Boolean类型，true：按shift，然后单击以更新地图
                isClickRecenter:false,
                logo: false,
                // 最大地图缩放级别，无法放大到此级别以上
                maxZoom:ConfigSetting.MapmaxLevel * 1,
                // 最小地图缩放级别，无法缩小到此级别以上
                minZoom:ConfigSetting.MapminLevel * 1,
                // Boolean类型，缩放时是否启用了淡入淡出效果
                fadeOnZoom: true,
                // Boolean类型，true：对于包含平铺地图服务图层的地图，确保将其捕捉到当前设置的范围。
                fitExtent: true,
                // Boolean类型，双击地图是否会放大范围
                isDoubleClickZoom: true,
            });
            
            	// new SpatialReference(wkid/wkt); 
            	// ArcGIS 10以下的版本只支持wkid,wkid包含投影坐标系列表，地理坐标系列表: 'wkid':4326
                mapSatialReference = new SpatialReference(mapSatialReference);
                objectId = "#"+mapElement;
                // map.on("extent-change", showExtent);
                // function showExtent(ext){
                //     var extentString = "";
                //     extentString = "XMin: " + ext.extent.xmin +
                //         " YMin: " + ext.extent.ymin +
                //         " XMax: " + ext.extent.xmax +
                //         " YMax: " + ext.extent.ymax;
                // }
                displayTutzenData = Layer;

            if(option){
                /* object2 合并到 object1 中 
               	   $.extend(object1, object2);
                */
                optionDefault = $.extend(optionDefault,option);
            }
            
            // onLoad: 将第一层或基础层成功添加到地图时触发
            map.on("load", function () {
                var nowMap = this;
                    // var startExtent = new Extent(119.42253812669179, 31.598889095809767, 119.45604093765388, 31.612556719827253,
                    //     map.spatialReference );
                    // map.setExtent(startExtent);
                
                	// 不允许双击地图放大地图并居中。
                    nowMap.disableDoubleClickZoom();
                	// 不允许点击地图以使其居中
                    nowMap.disableClickRecenter();
                
                // dojo.connect(obj, event, context, method, dontFix?);
                // >> obj  Object|null: 事件的关联对象
                // >> event  String: obj需要关联对象的名称
                // >> context  Object|null: 为后面的method提供了上下文环境，相当于method的this
                // >> method  String|Function: 当event被触发后调用的目标函数
                // >> dontFix  Boolean: true: 可以阻止关联被委托到DOM事件管理器
                // 初始化设置高度
                dojo.connect(map, "onZoomEnd", function (extent, zoomFactor, anchor) {
                    // 获取当前地图的等级详情
                    var level = map.getLevel();
                    // mapLevelAggregation: 默认级别为 6
                    if (level <= mapLevelAggregation) {
                        showPoint(false);
                    } else {
                        showPoint(true);
                    }
                });
                //设置中心节点
                $.post(urlcenterPoint, function (data) {
                    if (data.state == "SUCCESS") {
                        if (data.rows.length > 0) {
                            var rowdata = data.rows[0];
                            var cPoint;
                            // 将查询到的中心节点X，Y的值进行存储
                            mapCenterPointVal={x:rowdata.longitude,y:rowdata.latitude};
                            // site.properties中的配置信息，判断是否是Mercator
                            if(ConfigSetting.isWebMercator == "true"){
                                // 将给定的纬度和经度值转换为Web Mercator
                                // lngLatToXY（long，lat）
                                // >> long: 要转换的经度值，lat: 要转换的维度值
                                var normalizedVal = webMercatorUtils.lngLatToXY(rowdata.longitude, rowdata.latitude);
                                // 使用x，y和空间参考创建一个新的Point对象
                                // new Point（x，y，SpatialReference）
                                // >> x,y:相关坐标，SpatialReference: 定义地图，图层或任务参数的空间参考
                                cPoint = new esri.geometry.Point(normalizedVal[0], normalizedVal[1],mapSatialReference);
                                // 
                            }else{
                                cPoint = new esri.geometry.Point(rowdata.longitude, rowdata.latitude,mapSatialReference);
                            }
                            // centerAndZoom(mapPoint, levelOrFactor)
                            // >> mapPoint: 地图居中于指定的x，y位置
                            // >> levelOrFactor: 
                            // >> >> 使用ArcGISTiledMapServiceLayer: 地图将缩放到指定的级别
                            // >> >> 使用DynamicMapServiceLayer: 地图将按指定的因子放大或缩小
                            nowMap.centerAndZoom(cPoint, rowdata.mapLevel);
                            
                            if (rowdata.mapLevel <= mapLevelAggregation) {
                                showPoint(false);
                            } else {
                                showPoint(true);
                            }
                            // 将中心点设置为全局
                            _cPoint = cPoint;

                        }else{
                            if (nowMap.getLevel() <= mapLevelAggregation) {
                                showPoint(false);
                            } else {
                                showPoint(true);
                            }
                        }
                        // 对底图的范围进行调整
                        mapExtentChangeCtrol.changeInit(map)
                    }
                }, "json");
                
                // 判断图层中是否有相关属性
                if (showToolBar()) {
                    // 对前端样式根据图层信息进行初始化
                    initToolBar(mapElement);
                    // 初始化地图工具栏- 
                    _initMapToolbar();
                }
            });
            drawToolBar = null;
            // 当前obj地址
            currentPageObject = obj;
            // 初始化底图h
            // WebTiledLayer类提供了一种简单的方法来将非ArcGIS Server地图图块添加为地图的图层
            if(ConfigSetting.MapServiceContract == "WebTiledLayer"){
                var mapParam = {};
                $.ajaxSettings.async = false;
                $.get("/js/MapInfoParams.json", function (param) {
                    // 将MapInfoParam中的json数据存储到mapParam中
                    mapParam = param;
                    if (!mapParam) {
                        alert("请正确配置参数！");
                        return;
                    }else{
                        // Extent: 边界框的最小和最大X坐标和Y坐标
                        // new Extent(xmin, ymin, xmax, ymax, spatialReference) / new Extent(json)
                        // xmin: 范围包络线的左下X坐标
                        // ymin: 范围包络线的左下Y坐标
                        // xmax: 范围信封的右上角X坐标
                        // ymax: 范围包络线的右上Y坐标
                        // SpatialReference: 几何的空间参考
                        var fullExtent = new Extent(mapParam.fullExtent.xmin, mapParam.fullExtent.ymin, mapParam.fullExtent.xmax, mapParam.fullExtent.ymax, new SpatialReference({ 'wkid': mapParam.fullExtent.wkid }));
                        var initialExtent = new Extent(mapParam.initialExtent.xmin, mapParam.initialExtent.ymin, mapParam.initialExtent.xmax, mapParam.initialExtent.ymax, new SpatialReference({ 'wkid': mapParam.initialExtent.wkid }));
                        
                        // TileInfo: 包含有关ArcGISTiledMapServiceLayer的切片方案的信息
                        // ArcGISTiledMapServiceLayer: 使用ArcGIS Server REST API公开的缓存地图服务资源
                        var tileInfo=new TileInfo({
                            rows: mapParam.rows,
                            cols: mapParam.cols,
                            compressionQuality: mapParam.compressionQuality,
                            // 平铺方案的来源
                            origin: mapParam.origin,
                            // 切片模式的空间参考
                            spatialReference: new SpatialReference({ 'wkid': mapParam.wkid }),
                            // 定义切片方案的一系列详细级别
                            lods: mapParam.lods
                        });
                        var options = {
                            "fullExtent": fullExtent,
                            "initialExtent": initialExtent,
                            "tileInfo": tileInfo
                        };
                        // ArcGISTiledLayer: 离线的切片地图服务
                        // 基础底图（Basemap）可由在线的、离线的切片地图服务（ArcGISTiledLayer、ArcGISVectorTiledLayer）填充
                        streetLayer = new ArcGISTiledLayer(ConfigSetting.MAP_SERVER_URL,options);
                        map.addLayer(streetLayer,0);
                    }
                });
                
            // ArcgisRest: 使用ArcGIS Server REST API公开的缓存地图服务资源
            }else if(ConfigSetting.MapServiceContract == "ArcgisRest"){
                // ArcGISTiledMapServiceLayer: 允许您使用ArcGIS Server REST API公开的缓存地图服务资源
                streetLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_SERVER_URL, {id: "streetLayer"});
                // addLayer(layer, index?)
                // >> layer: 要添加到地图的图层
                // >> index: 可以在地图中的指定索引处添加图层
                map.addLayer(streetLayer, 0);
            }
            // 将ajax请求设置回异步
            $.ajaxSettings.async = true;
            // OverviewMap小部件在较大区域的上下文中显示地图的当前范围
            var overviewMapDijit = new esri.dijit.OverviewMap({
                map: map, // 必要的
                visible: true,    // 初始化可见，默认为false
                attachTo: "bottom-left", // 默认右上角
                width: 310,   // 默认值是地图高度的 1/4th
                height: 200, // 默认值是地图高度的 1/4th
                // opacity: 0.,  // 透明度 默认0.5
                maximizeButton: false, // 最大化,最小化按钮，默认false
                // expandFactor: 0.4,    //概览地图和总览图上显示的程度矩形的大小之间的比例。默认值是2，这意味着概览地图将至少是两倍的大小的程度矩形。
                // color: "red"  // 默认颜色为#000000
            });
            // 完成对OverviewMap dijit的创建
            overviewMapDijit.startup();
            // GraphicsLayer: 包含一个或多个图形特征的图层
            // ID: 分配给图层的ID。如果未分配，则esri.Map分配值
            tollgateLayer = new esri.layers.GraphicsLayer({id: "tollgateLayer"});
            map.addLayer(tollgateLayer);
            videoLayer = new esri.layers.GraphicsLayer({id: "videoLayer"});
            map.addLayer(videoLayer, 2);
            caseInfoLayer = new esri.layers.GraphicsLayer({id: "caseInfoLayer"});
            map.addLayer(caseInfoLayer, 3);
            warnInfoLayer = new esri.layers.GraphicsLayer({id: "warnInfoLayer"});
            map.addLayer(warnInfoLayer, 4);
            // ArcGISTiledMapServiceLayer: 允许您使用ArcGIS Server REST API公开的缓存地图服务资源
            ImgLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_IMAGE_URL, {id: "ImgLayer"});
            map.addLayer(ImgLayer, 5);
            ImgLayer.setVisibility(false);
            // ArcGISTiledMapServiceLayer: 允许您使用ArcGIS Server REST API公开的缓存地图服务资源
            nightLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_NIGHT_URL, {id: "nightLayer"});
            map.addLayer(nightLayer, 6);
            nightLayer.setVisibility(false);
            getData();

        });

        return map;
    };
    
    // flag: true/false 
    var showPoint = function (flag) {
        if (flag) {
            $(objectId+" #LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                // 返回layerId的属性值
                var layerId = $(this).attr("layerId");
                // 获取当前图层信息
                var layer = map.getLayer(layerId);
                
                // 将图层的可见性设置为true
                layer.show();
                if (videoclusterLayer != null) {
                    // 设置图层的可见性，如果为true：可见，false：不可见
                    videoclusterLayer.setVisibility(false);
                }
                if(tollgateclusterLayer!=null){
                     // 设置图层的可见性，如果为true：可见，false：不可见
                    tollgateclusterLayer.setVisibility(false);
                }
            });

        } else {
            $(objectId+" #LayerSearchContent .drawtoolDiv").find("input").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                // 将当前图层隐藏
                layer.hide();
            });
            $(objectId+" #LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                if(layerId == "videoLayer"){
                    if(videoclusterLayer!=null){
                         // 设置图层的可见性，如果为true：可见，false：不可见
                        videoclusterLayer.setVisibility(true);
                    }
                }
                if(layerId == "tollgateLayer"){
                    if(tollgateclusterLayer!=null){
                         // 设置图层的可见性，如果为true：可见，false：不可见
                        tollgateclusterLayer.setVisibility(true);
                    }
                }
            });
    }
    };

    var cleraLayerForMap = function () {

    };
    var drawPictureLayerForMap = function () {
        if (tollgateArr.length > 0) {
            drawTollgateLayer(tollgateArr);
        }
        if (videoArr.length > 0) {
            drawVideoLayer(videoArr);
        }
    };

    //初始化地图工具栏
    var _initMapToolbar = function () {
        require(["esri/geometry/Point"], function (Point) {
            var index = 1;
            /*漫游*/
            // off().on(): 使用off()移除是为了防止绑定重复事件
            $(objectId+" #Pan").off().on("click", function () {
                //注销测距工具
                if (measureTool && !measureTool._destroyed) {
                    measureTool.destroy();
                    $(objectId+" #measurePanel").hide();
                }
                //注销绘制工具
                if (drawToolBar) {
                    drawToolBar.deactivate();
                }
            });
            /*测距*/
            $(objectId+" #Measure").click(function () {
                __startMeasure();
            });
            /*全图*/
            $(objectId+" #FullExtent").click(function () {
                if (_cPoint != null) {
                    map.centerAndZoom(_cPoint, _defaultZoomLevel);
                }
            });
            /*影像*/
            $(objectId+" #image").click(function () {
                var imageLayer = map.getLayer("ImgLayer");
                if (imageLayer) {
                    imageLayer.setVisibility(!imageLayer.visible);
                }
            });
            //绘制查询
            $(objectId+" .toolDiv").click(function (evt) {
                var id = $(this).attr("id");
                map.infoWindow.hide();
                switch (id) {
                    //矩形
                    case "rectTool":
                        __mapDrawSearch("Rectangle");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //多边形
                    case "polygonTool":
                        __mapDrawSearch("Polygon");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //圆形
                    case "bufferTool":
                        __mapDrawSearch("Circle");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //清除
                    case "clearTool":
                        //清空绘制图层数据
                        var drawLayer = map.getLayer("drawLayer");
                        $(this).parent(".toolH").siblings().removeClass("selected");
                        if (drawLayer) {
                            drawLayer.clear();
                            $(objectId+" #bayonetresults").hide();
                        }
                        businessTollgateArr = [];
                        businessCameraArr = [];
                        businessCaseInfoArr = [];
                        businessWarnInfoArr = [];
                        if (currentPageObject.getDrawHandlerResult && typeof(currentPageObject.getDrawHandlerResult) == "function") {
                            currentPageObject.getDrawHandlerResult(businessTollgateArr, businessCameraArr, businessCaseInfoArr, businessWarnInfoArr,true)
                        }
                        // if (currentPageObject.getclearTool && typeof(currentPageObject.getclearTool) == "function") {
                        //     currentPageObject.getclearTool()
                        // }
                        //注销测距工具
                        if (measureTool && !measureTool._destroyed) {
                            measureTool.destroy();
                            $(objectId+" #measurePanel").hide();
                            $(objectId+" #measurePanel").hide().html("");
                        }
                        //注销绘制工具
                        if (drawToolBar) {
                            drawToolBar.deactivate();
                        }
                        /*清除已选卡口*/
                        break;
                    default:
                        break;
                }

            });

            /*工具条下拉*/
            $(objectId+" #DrawSearchBtn").click(function (e) {
                e.stopPropagation();
                $(this).parent().parent().siblings().find(".extentTools").hide();
                $(this).parent().parent().siblings().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                $(this).parent().find(".extentTools").toggle();
                if ($(this).parent().find(".toolexpand").attr("src") == "/images/map/toolbar/down-hover.png") {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/up-hover.png");
                }
                else {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/down-hover.png");
                }


                //点击页面其他位置收起工具条下拉
                $(document).click(function () {
                    $(".toolexpand").each(function () {
                        if ($(this).attr("src") == "/images/map/toolbar/up.png") {
                            $(this).parent().click();
                        }
                    });
                });
            });
            /*图层下拉*/
            $(objectId+" #LayerSearch").click(function (e) {
                e.stopPropagation();
                $(this).parent().parent().siblings().find(".extentTools").hide();
                $(this).parent().parent().siblings().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                $(this).parent().find(".extentTools").toggle();
                if ($(this).parent().find(".toolexpand").attr("src") == "/images/map/toolbar/down-hover.png") {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/up-hover.png");
                }
                else {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/down-hover.png");
                }
                //点击页面其他位置收起工具条下拉
                $(document).click(function () {
                    $(".toolexpand").each(function () {
                        if ($(this).attr("src") == "/images/map/toolbar/up.png") {
                            $(this).parent().click();
                        }
                    });
                });
            });
            $(objectId+" #LayerSearchContent").off().on("click", function (e) {
                e.stopPropagation();
            });
            $("input[name='checkbox']").change(function (e) {
                var layerId = $(this).attr("layerId");
                var flag = this.checked;
                changeLayer(layerId, flag);
            })

        });
        //添加hover样式
        // 矩形
        $("#drawRect").hover(function(){
            $(this).attr("src","/images/map/toolbar/rect-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/rect.png")
        });
        //多边形
        $("#drawPolygon").hover(function(){
            $(this).attr("src","/images/map/toolbar/polygon-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/polygon.png")
        });
        //圆形
        $("#drawBuffer").hover(function(){
            $(this).attr("src","/images/map/toolbar/round-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/round.png")
        });
        //清除
        $("#drawClear").hover(function(){
            $(this).attr("src","/images/map/toolbar/clear-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/clear.png")
        });
        //图层切换
        //判断小箭头状态 双判断
        //更改了上面点击的判断  /*图层下拉*/
        $("#LayerSearchBtn").hover(function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers-hover.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers-hover.png")
            }
        },function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers.png")
            }
        });
        //地图其他操作
        //判断小箭头状态 双判断
        // 更改了上面点击的判断 /*工具条下拉*/
        $("#DrawSearchBtn").hover(function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw-hover.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw-hover.png")
            }
        },function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw.png")
            }
        });
        // 地图其他操作的三个小图标
        //测距
        $("#Measure").hover(function(){
            $(this).find("img").attr("src","/images/map/toolbar/measure-hover.png")
        },function(){
            $(this).find("img").attr("src","/images/map/toolbar/measure.png")
        });
        //全图
        $("#FullExtent").hover(function(){
            $(this).find("img").attr("src","/images/map/toolbar/fullextent-hover.png")
        },function(){
            $(this).find("img").attr("src","/images/map/toolbar/fullextent.png")
        });
        //影像
        $("#image").hover(function(){
            $(this).find("img").attr("src","/images/map/toolbar/image-hover.png")
        },function(){
            $(this).find("img").attr("src","/images/map/toolbar/image.png")
        });
    };
    /*显示隐藏图层*/
    function changeLayer(layerId, flag) {
        var layer = map.getLayer(layerId);
        var level = map.getLevel();
        if (level <= mapLevelAggregation) {
            if (flag) {
                if (layerId == "videoLayer") {
                    if (videoclusterLayer != null) {
                        videoclusterLayer.setVisibility(true);
                    }
                }
                if (layerId == "tollgateLayer") {
                    if (tollgateclusterLayer != null) {
                        tollgateclusterLayer.setVisibility(true);
                    }
                }
            } else {
                if (layerId == "videoLayer") {
                    if (videoclusterLayer != null) {
                        videoclusterLayer.setVisibility(false);
                    }
                }
                if (layerId == "tollgateLayer") {
                    if (tollgateclusterLayer != null) {
                        tollgateclusterLayer.setVisibility(false);
                    }
                }
            }
        }else{

            if (flag) {
                layer.show();
            } else {
                layer.hide();
            }
        }
    }

    //end 轨迹
    var __startMeasure = function () {
        require(["esri/geometry/Polyline", "esri/geometry/Point", "esri/dijit/Measurement", "esri/units"],
            function (Polyline, Point, Measurement, units) {
                var customPolyline = new Polyline();
                customPolyline.addPath([
                    new Point(0, 0,mapSatialReference),
                    new Point(0, 0,mapSatialReference),
                    new Point(0, 0,mapSatialReference)
                ]);
                if (!measureTool || measureTool._destroyed) {
                    measureTool = Measurement({
                        map: map,
                        geometry: customPolyline,
                        defaultLengthUnit: units.METERS
                    });
                }
                if (measureHanlder) {
                    measureHanlder.remove();
                }
                measureTool.startup();
                $(objectId+" #measurePanel").show();
                measureHanlder = measureTool.on("measure", function (evt) {
                    var result = evt.values;
                    $(objectId+" #measurePanel").text("距离：" + result.toFixed(2) + "米");
                });
            });
    };
    //地图图形查询
    var __mapDrawSearch = function (geometryType) {
        require(["esri/toolbars/draw", "esri/graphic", "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
                "esri/layers/GraphicsLayer", "esri/Color", "esri/geometry/webMercatorUtils", "esri/tasks/query",
                "esri/tasks/QueryTask", "esri/tasks/IdentifyTask", "esri/tasks/IdentifyParameters"],
            function (Draw, Graphic, SimpleFillSymbol, SimpleLineSymbol, GraphicsLayer, Color, webMercatorUtils, Query, QueryTask, IdentifyTask, IdentifyParameters) {
                //每次绘制前，清空已绘制图形
                var drawLayer = map.getLayer("drawLayer");
                if (drawLayer) {
                    drawLayer.clear();
                    $(objectId+" #bayonetresults").hide();
                    $(objectId+" .toolH").removeClass("selected");
                } else {
                    drawLayer = new GraphicsLayer({"id": "drawLayer"});
                    map.addLayer(drawLayer);
                }

                //防止开始绘制前多次绑定绘制完成的方法
                if (drawEndHandler) {
                    dojo.disconnect(drawEndHandler);
                }
                //防止开始绘制前多次初始化绘制工具
                if (drawToolBar) {
                    drawToolBar.deactivate();
                }
                else {
                    drawToolBar = new Draw(map);
                }
                switch (geometryType) {
                    case "Rectangle":
                        drawToolBar.activate(esri.toolbars.Draw.RECTANGLE);
                        break;
                    case "Polygon":
                        drawToolBar.activate(esri.toolbars.Draw.POLYGON);
                        break;
                    case "Circle":
                        drawToolBar.activate(esri.toolbars.Draw.CIRCLE);
                        break;
                    case "Polyline":
                        drawToolBar.activate(esri.toolbars.Draw.POLYLINE);
                        break;
                    default:
                        break;
                }
           		// 
                drawEndHandler = dojo.connect(drawToolBar, "onDrawEnd", function (geometry) {
                    dojo.disconnect(drawEndHandler);
                    //清除选中状态 清除地图圈选范围
                    $(objectId+" .toolH").siblings().removeClass("selected");
                    //清空数据
                    businessTollgateArr = [];
                    businessCameraArr = [];
                    businessCaseInfoArr = [];
                    businessWarnInfoArr = [];
                    var symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]));
                    var graphic = new Graphic(geometry, symbol);
                    drawLayer.add(graphic);
                    drawToolBar.deactivate();
                    var selectArr = [];
                    $(objectId+" #LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                        var layerId = $(this).attr("layerId");
                        var layer = map.getLayer(layerId);
                        if (layer.visible) {
                            for (var i = 0, c = layer.graphics.length; i < c; i++) {
                                if(ConfigSetting.isWebMercator == "true"){
                                    var p = webMercatorUtils.webMercatorToGeographic(layer.graphics[i].geometry);
                                }else{
                                    var p = layer.graphics[i].geometry
                                }
                                if (geometry.contains(p)) {
                                    selectArr.push(layer.graphics[i]);
                                }
                            }
                        }
                    })
                    for (var i = 0; i < selectArr.length; i++) {
                        if (selectArr[i].attributes.species == "tollgate") {
                            businessTollgateArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "camera") {
                            businessCameraArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "caseInfo") {
                            businessCaseInfoArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "warnInfo") {
                            businessWarnInfoArr.push(selectArr[i])
                        }
                    }
                    if (currentPageObject.getDrawHandlerResult && typeof(currentPageObject.getDrawHandlerResult) == "function") {
                        currentPageObject.getDrawHandlerResult(businessTollgateArr, businessCameraArr, businessCaseInfoArr, businessWarnInfoArr)
                    }
                });
            });
    };
    var clearDraw = function () {

    };

    function getData() {
        // esri/geometry/webMercatorUtils: 将webMercator坐标转化为地理坐标
        require(["esri/dijit/OverviewMap","extras/ClusterLayer",
                "dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
                "esri/renderers/ClassBreaksRenderer","esri/symbols/SimpleLineSymbol",
                "esri/Color","esri/geometry/webMercatorUtils"],
            function (OverviewMap,ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,SimpleLineSymbol,Color,webMercatorUtils) {
                if (displayTutzenData.tollgate.length > 0) {
                    $.post(urltollgateList, {tollgateType: displayTutzenData.tollgate.join(",")}, function (tollgateData) {
                        tollgateArr = [];
                        if (tollgateData && tollgateData.state == "SUCCESS") {
                            var tollgateList = tollgateData.rows;
                            // filter(function(currentValue,index?,arr?), thisValue?)
                            // >> currentValue: 当前元素的值
                            // >> index: 当前元素的索引值
                            // >> arr: 当前元素属于的数组对象
                            // >> thisValue: 对象作为该执行回调时使用，传递给函数
                            tollgateArr = tollgateList.filter(function (o, i) {
                                o.id = i;
                                o.dataId = o.tollgateId;
                                o.text = o.tollgateName;
                                o.x = o.longitude;
                                o.y = o.latitude;
                                o.name = o.tollgateName;
                                o.attributes =  {
                                    "x":o.longitude,
                                    "y":o.latitude,
                                    "name":o.tollgateName
                                };
                                return true;
                            });
                            var countyInfo = {};
                            // 
                            countyInfo.data = arrayUtils.map(tollgateArr, function(item) {
                                var webMercator;
                                if(ConfigSetting.isWebMercator == "true"){
                                    // 将几何图形从地理单位转换为Web墨卡托单位，返回类型: Geometry
                                    // >> geographicToWebMercator(geometry)
                                    // new Point（x，y，SatialReference）:使用x，y和空间参考创建一个新的Point对象
                                    // >> x:点在地图单位中的X坐标，
                                    // >> y:点在地图单位中的Y坐标，
                                    // >> SatialReference: 几何的空间参考
                                     webMercator = webMercatorUtils.geographicToWebMercator(new Point(parseFloat(item.x), parseFloat(item.y), mapSatialReference));
                                }else{
                                     webMercator = {"x":item.x, "y": item.y}
                                }
                                // var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                                // var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                                var attributes = {
                                    "名称": item.name,
                                    "经度": item.x,
                                    "纬度": item.y
                                };
                                return {
                                    "x": webMercator.x,
                                    "y": webMercator.y,
                                    "attributes": attributes
                                };
                            });
                            
                            // 创建ClusterLayer图层，ClusterLayer: 点聚合
                            tollgateclusterLayer = new ClusterLayer({
                                // 
                                "data": countyInfo.data,
                                "distance": 150,
                                "id": "clusterstollgate",
                                "labelColor": "#1854ef",
                                "labelOffset": 13,
                                "spatialReference":mapSatialReference,
                                // "resolution": map.extent.getWidth() / map.width,
                            });
                            // 构造方法：new ClassBreaksRenderer（defaultSymbol，attributeField）
                            // 渲染器的默认符号。此符号用于不匹配的值。此参数是必需的，可以为null或空对象。
                            var defaultSym = new esri.symbols.SimpleMarkerSymbol();
                            // renderer: 类中断渲染器,根据某些数字属性的值来符号化每个图形
                            // clusterCount: 指定渲染器用来匹配值的属性字段
                            	// >> 根据聚合点个数clustercount来进行分类渲染
                            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                            // new PictureMarkerSymbol（URL，宽度，高度）
                            // setOffset（x，y）: 以屏幕为单位设置标记的x和y偏移量。
                            var blue = new esri.symbols.PictureMarkerSymbol("/images/icons/kkjh.png", 54, 32).setOffset(0, 15);
                            var muckle = new esri.symbol.PictureMarkerSymbol("/images/icons/kkjhb.png", 88, 34).setOffset(0, 15);
                            // addBreak（minValueOrInfo，maxValue ?, symbol？）：设置渲染间隔
                            renderer.addBreak(0, 999, blue);
                            renderer.addBreak(999, tollgateArr.length, muckle);
                            // 设置图形层的渲染器
                            tollgateclusterLayer.setRenderer(renderer);
                            // 给地图添加图层
                            map.addLayer(tollgateclusterLayer);
                            // 设置该图层不可见 ================================
                            tollgateclusterLayer.setVisibility(false);
                            drawTollgateLayer(tollgateArr);
                        }
                    }, "json");
                }
            	// 
                if (displayTutzenData.video&&optionDefault.initCamera) {
                    $.post(urlcameraList, function (tollgateData) {
                        videoArr = [];
                        if (tollgateData && tollgateData.state == "SUCCESS") {
                            var tollgateList = tollgateData.rows;
                            videoArr = tollgateList.filter(function (o, i) {
                                o.id = i;
                                o.dataId = o.cameraId;
                                o.text = o.cameraName;
                                o.x = o.longitude;
                                o.y = o.latitude;
                                o.name = o.cameraName;
                                o.attributes =  {
                                    "x":o.longitude,
                                    "y":o.latitude,
                                    "name":o.cameraName
                                };
                                return true;
                            });
                            var countyInfoVideo = {};
                            countyInfoVideo.data = arrayUtils.map(videoArr, function(item) {
                                var webMercator;
                                if(ConfigSetting.isWebMercator == "true"){
                                    webMercator = webMercatorUtils.geographicToWebMercator(new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference));
                                }else{
                                    webMercator = {"x":item.x, "y": item.y}
                                }
                                // var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                                // var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                                var attributes = {
                                    "名称": item.name,
                                    "经度": item.x,
                                    "纬度": item.y
                                };
                                return {
                                    "x": webMercator.x,
                                    "y": webMercator.y,
                                    "attributes": attributes
                                };
                            });
                            videoclusterLayer = new ClusterLayer({
                                "data": countyInfoVideo.data,
                                "distance": 150,
                                "id": "clustersvideo",
                                "labelColor": "#18abef",
                                "labelOffset": 13,
                                // "resolution": map.extent.getWidth() / map.width,
                                "spatialReference":mapSatialReference,
                                // "singleColor": "#f00",
                                // "maxSingles":3000
                            });
                            var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                            var green = new esri.symbols.PictureMarkerSymbol("/images/icons/xjjh.png", 54, 32).setOffset(0, 15);
                            var muckle = new esri.symbol.PictureMarkerSymbol("/images/icons/xjjhb.png", 88, 34).setOffset(0, 15);
                            renderer.addBreak(0, 999, green);
                            renderer.addBreak(999, videoArr.length, muckle);
                            videoclusterLayer.setRenderer(renderer);
                            map.addLayer(videoclusterLayer);
                            videoclusterLayer.setVisibility(false);
                            drawVideoLayer(videoArr);
                        }
                    }, "json");
                }
                // if (displayTutzenData.warnInfo) {
                //     $.post(urlWarnInfoList, function (tollgateData) {
                //         warnInfoArr = [];
                //         if (tollgateData && tollgateData.state == "SUCCESS") {
                //             var alarmList = tollgateData.rows;
                //             for (j  in alarmList) {
                //                 warnInfoArr.push({
                //                     dataId: alarmList[j].warnId,
                //                     text: alarmList[j].warnTitle,
                //                 });
                //             }
                //             warnInfoArr = warnInfoArr.filter(function (o, i) {
                //                 o.id = i;
                //                 return true;
                //             });
                //         }
                //     }, "json");
                // }
                // if (displayTutzenData.case) {
                //     $.post(urlCaseInfoList, function (tollgateData) {
                //         caseInfoArr = [];
                //         if (tollgateData && tollgateData.state == "SUCCESS") {
                //             var tollgateList = tollgateData.rows;
                //             caseInfoArr = tollgateList.filter(function (o, i) {
                //                 o.id = i;
                //                 o.dataId = o.caseId;
                //                 o.text = o.caseName;
                //                 return true;
                //             });
                //         }
                //     }, "json");
                // }
        })
    }

    // 对前端样式根据图层信息进行初始化
    function initToolBar(mapEl) {
        $("#" + mapEl).append($("#mapToolbar").html());
        if (displayTutzenData.tollgate.length == 0) {
            $(objectId+" #selDivPan .showcasing.tollgate").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.tollgate").remove();
        }
        if (!displayTutzenData.video) {
            $(objectId+" #selDivPan .showcasing.video").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.video").remove();
        }
        if (!displayTutzenData.case) {
            $(objectId+" #selDivPan .showcasing.case").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.caseInfo").remove();
        }
        if (!displayTutzenData.warnInfo) {
            $(objectId+" #selDivPan .showcasing.alarm").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.warnInfo").remove();
        }
        $(objectId+" #mapLocate").off().on("click", function () {
            if ($(objectId+" .card").hasClass("animated-card")) {
                $(objectId+" #selHidden").hide();
                $(objectId+" .selected").removeClass("selectedSel2");
                $(objectId+" .card").removeClass("animated-card");
            } else {
                $(objectId+" .card").addClass("animated-card");
                $(objectId+" .showcasing").removeClass("selectedSel2");
            }
        });
        $(objectId+" .showcasing").off().on("click", function () {
            if ($(this).hasClass("selectedSel2")) {
                $(objectId+" #selHidden").hide();
                $(this).removeClass("selectedSel2");
            } else {
                $(objectId+" .showcasing").removeClass("selectedSel2");
                $(objectId+" #selHidden").show();
                $(this).addClass("selectedSel2");
                if ($(this).hasClass("tollgate")) {
                    bindData("卡口", tollgateArr);
                }
                if ($(this).hasClass("video")) {
                    bindData("视频", videoArr);
                }
                if ($(this).hasClass("case")) {
                    bindData("案件", caseInfoArr);
                }
                if ($(this).hasClass("alarm")) {
                    bindData("警情", warnInfoArr);
                }
            }
        });
    }

    function bindData(text, dataArr) {
        require(["esri/geometry/webMercatorUtils"],
            function (webMercatorUtils) {
                $(objectId+" #selTollgate").empty().off("change");
                $(objectId+" #selTollgate").select2({
                    placeholder: "请输入" + text + "名称",
                    allowClear: true,
                    multiple: false,
                    data: dataArr,
                    width: null
                }).val(null).trigger("change").on("change", function (e) {
                    var val = $(objectId+" #selTollgate").val();
                    if (val == null) {
                        return;
                    }
                    positioningLayer = map.getLayer("positioningLayer");
                    if (positioningLayer != null) {
                        positioningLayer.clear();
                    } else {
                        positioningLayer = new esri.layers.GraphicsLayer({id: "positioningLayer"});
                        map.addLayer(positioningLayer);
                    }
                    if (dataArr[val].longitude != 0 && dataArr[val].longitude != '' && dataArr[val].longitude != null) {
                        var cPoint;
                        if(ConfigSetting.isWebMercator == "true"){
                           	// 将给定的纬度和经度值转换为Web Mercator
                            // lngLatToXY（long，lat）
                            // >> long: 要转换的经度值，lat: 要转换的维度值
                            var normalizedVal = webMercatorUtils.lngLatToXY(dataArr[val].longitude, dataArr[val].latitude);
                            cPoint = new esri.geometry.Point(normalizedVal[0], normalizedVal[1],mapSatialReference);
                        }else{
                            cPoint = new esri.geometry.Point(dataArr[val].longitude,dataArr[val].latitude,mapSatialReference);
                        }
                        var alarm_g = new esri.Graphic(cPoint);
                        alarm_g.setSymbol(arraySymbol);
                        positioningLayer.add(alarm_g);
                        /*如果当前为聚合状态,放大到聚合层级+1;如果为展开状态,不用放大层级*/
                        var nowLevel = map.getLevel();
                        var level = (nowLevel>ConfigSetting.MAP_MapClusterLayer?nowLevel:(ConfigSetting.MAP_MapClusterLayer-0+1));
                        map.centerAndZoom(cPoint,level);
                        $(positioningLayer.getNode()).animate({opacity: 0}, 600).animate({opacity: 0.8}, 600).animate({opacity: 0}, 600).animate({opacity: 1}, 600, function () {
                            positioningLayer.clear();
                        });
                        if (currentPageObject.accessToLocate && typeof(currentPageObject.accessToLocate) == "function") {
                            currentPageObject.accessToLocate(dataArr[val])
                        }
                    } else {
                        common.showWarn("点位坐标未配置", "提示")
                    }
                }).on("select2:open",function(){
                    $(objectId+" #selTollgate").val(-1);
                });
            });

    }

    function showToolBar() {
        var flag = false;
        // 对图层中的属性进行判断?  ===================
        if (displayTutzenData.tollgate.length > 0 || displayTutzenData.video || displayTutzenData.warnInfo || displayTutzenData.case) {
            flag = true;
        }
        return flag;
    }
	
    var drawTollgateLayer = function (data) {
    	// 初始化图层
        require(["esri/geometry/webMercatorUtils"],
            function (webMercatorUtils) {
                if (tollgateLayer) {
                    tollgateLayer.clear();
                }
                for (var i = 0; i < data.length; i++) {
                    var alarm_x = data[i].longitude;
                    var alarm_y = data[i].latitude;
                    var alarm_type = data[i].tollgateType;
                    var alarm_attr = {
                        "name": data[i].tollgateName,
                        "id": data[i].tollgateId,
                        "type": data[i].tollgateType,
                        "species": "tollgate",
                        "longitude": data[i].longitude,
                        "latitude": data[i].latitude,
                        "states": ""
                    };
                    var webMercator;
                    if(ConfigSetting.isWebMercator == "true"){
                        // 将给定的纬度和经度值转换为Web Mercator
                        // lngLatToXY（long，lat）
                        // >> long: 要转换的经度值，lat: 要转换的维度值
                        webMercator = webMercatorUtils.lngLatToXY(alarm_x, alarm_y);
                    }else{
                        webMercator =[alarm_x, alarm_y];
                    }
                    // var alarm_p = new Point(webMercator[0], webMercator[1],mapSatialReference);
                    // var alarm_g = new esri.Graphic(alarm_p);
                    var alarm_g = new esri.Graphic(new esri.geometry.Point(webMercator[0], webMercator[1],mapSatialReference));

                    alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/tollgate/gis"+alarm_type+".png", 26, 34).setOffset(0,16));

                    tollgateLayer.add(alarm_g);
                    alarm_g.setAttributes(alarm_attr);
                }
            })

    };
    var drawVideoLayer = function (data) {
        require(["esri/geometry/webMercatorUtils"],
            function (webMercatorUtils) {
                if (videoLayer) {
                    videoLayer.clear();
                }
                for (var i = 0; i < data.length; i++) {
                    var alarm_x = data[i].longitude;
                    var alarm_y = data[i].latitude;
                    var alarm_states = data[i].status;
                    var alarm_type = data[i].cameraType;
                    var alarm_attr = {
                        "name": data[i].cameraName,
                        "id": data[i].cameraId,
                        "type": data[i].cameraType,
                        "species": "camera",
                        "longitude": data[i].longitude,
                        "latitude": data[i].latitude,
                        "states": data[i].status,
                        "playCtrl":data[i].playControl
                    };
                    var webMercator;
                    if(ConfigSetting.isWebMercator == "true"){
                        // 将给定的纬度和经度值转换为Web Mercator
                        // lngLatToXY（long，lat）
                        // >> long: 要转换的经度值，lat: 要转换的维度值
                        webMercator = webMercatorUtils.lngLatToXY(alarm_x, alarm_y);
                    }else{
                        webMercator =[alarm_x, alarm_y]
                    }
                    // var alarm_p = new Point(webMercator[0], webMercator[1],mapSatialReference);
                    // var alarm_g = new esri.Graphic(alarm_p);
                    var alarm_g = new esri.Graphic(new esri.geometry.Point(webMercator[0], webMercator[1],mapSatialReference));
                    // if (alarm_states == "0" && alarm_type == "1") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/shootingGis.png", 26, 34));
                    // }
                    // if (alarm_states == "1" && alarm_type == "1") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/shootingFailureGis.png", 26, 34));
                    // }
                    // if (alarm_states == "0" && alarm_type == "2") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/skillGis.png", 26, 34));
                    // }
                    // if (alarm_states == "1" && alarm_type == "2") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/skillFailureGis.png", 26, 34));
                    // }
                    alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/camera/gis"+alarm_type+(alarm_states==1?"_off":"")+".png", 26, 34).setOffset(0,16));
                    videoLayer.add(alarm_g);
                    alarm_g.setAttributes(alarm_attr);
                }
            });

    };
    var drawCaseInfoLayer = function (data) {

        if (caseInfoLayer != null) {
            caseInfoLayer.clear();
        }
        ;
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longitude;
            var alarm_y = data[i].latitude;
            var alarm_attr = {
                "name": data[i].caseName,
                "id": data[i].caseNo,
                "type": "",
                "species": "caseInfo",
                "longitude": data[i].longitude,
                "latitude": data[i].latitude,
                "states": "",
                "time": data[i].startTime
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y,map.spatialReference));
            alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/caseGis.png", 20, 20));
            caseInfoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }

    };
    var drawWarnInfoLayer = function (data) {
        if (warnInfoLayer != null) {
            warnInfoLayer.clear();
        }
        ;
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longtitude;
            var alarm_y = data[i].latitude;
            var alarm_attr = {
                "name": data[i].warnTitle,
                "id": data[i].warnId,
                "species": "warnInfo",
                "longitude": data[i].longtitude,
                "latitude": data[i].latitude,
                "states": "",
                "time": data[i].warnTime
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y,map.spatialReference));
            alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/alarmLocation.png", 20, 20));
            warnInfoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }
    };
    var updateVideoArr = function(arr){
        require(["extras/ClusterLayer","dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
                "esri/renderers/ClassBreaksRenderer","esri/geometry/webMercatorUtils"],
            function (ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,webMercatorUtils) {
                videoArr = arr.filter(function (o, i) {
                    o.id = i;
                    o.dataId = o.cameraId;
                    o.text = o.cameraName;
                    o.x = o.longitude;
                    o.y = o.latitude;
                    o.name = o.cameraName;
                    o.attributes = {
                        "x": o.longitude,
                        "y": o.latitude,
                        "name": o.cameraName
                    };
                    return true;
                });
                var countyInfoVideo = {};
                countyInfoVideo.data = arrayUtils.map(videoArr, function (item) {
                    var webMercator;
                    if(ConfigSetting.isWebMercator == "true"){
                        webMercator = webMercatorUtils.geographicToWebMercator(new Point(parseFloat(item.x), parseFloat(item.y), mapSatialReference));
                    }else{
                        webMercator = {"x":item.x, "y": item.y}
                    }
                    // var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                    // var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                    var attributes = {
                        "名称": item.name,
                        "经度": item.x,
                        "纬度": item.y
                    };
                    return {
                        "x": webMercator.x,
                        "y": webMercator.y,
                        "attributes": attributes
                    };
                });
                videoclusterLayer = new ClusterLayer({
                    "data": countyInfoVideo.data,
                    "distance": 150,
                    "id": "clustersvideo",
                    "labelColor": "#18abef",
                    "labelOffset": 13,
                    "resolution": null,
                    "spatialReference":mapSatialReference,
                    // "singleColor": "#f00",
                    // "maxSingles":3000
                });
                var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                var green = new esri.symbols.PictureMarkerSymbol("/images/icons/xjjh.png", 54, 32).setOffset(0, 15);
                var muckle = new esri.symbol.PictureMarkerSymbol("/images/icons/xjjhb.png", 88, 34).setOffset(0, 15);
                renderer.addBreak(0, 999, green);
                renderer.addBreak(999, videoArr.length, muckle);
                videoclusterLayer.setRenderer(renderer);
                map.addLayer(videoclusterLayer);
                videoclusterLayer.setVisibility(false);
                drawVideoLayer(videoArr);
            })
    }
    return {
        // mapElement: 容器的id 
        // obj: 当前的地址
        // Layer: 根据Layer中的不同值，对不同数据库进行查询
        init: function (mapElement, obj, Layer,option) {
            // console.debug("调试地图功能");
            return _initMap(mapElement, obj, Layer,option);
        },
        getMap: function () {
            return map;
        },
        setCaseInfoArr: function (arr) {
            caseInfoArr = arr.filter(function (o, i) {
                o.id = i;
                o.dataId = o.caseId;
                o.text = o.caseName;
                return true;
            });
            drawCaseInfoLayer(arr)
        },
        setWarnInfoArr: function (arr) {
            warnInfoArr = arr.filter(function (o, i) {
                o.id = i;
                o.dataId = o.warnId;
                o.text = o.warnTitle;
                return true;
            });
            drawWarnInfoLayer(arr)
        },
        updataTollgateArr: function () {
            getData()
        },
        updateCamera:function(arr){
            updateVideoArr(arr);
        },
        getMapSpatialReference:function () {
           return mapSatialReference;
        }
    }

}();

```