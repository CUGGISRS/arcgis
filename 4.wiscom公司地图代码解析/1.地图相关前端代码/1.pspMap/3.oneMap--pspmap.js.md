oneMap--pspmap.js

```js
var pspMap = function () {

    dojo.require("esri.map");
    dojo.require("esri.config");
    dojo.require("esri.geometry.Point");
    dojo.require("esri.geometry.webMercatorUtils");
    dojo.require("esri.graphic");
    dojo.require("esri.layers.GraphicsLayer");
    dojo.require("esri.symbols.PictureMarkerSymbol");
    dojo.require("esri.symbols.SimpleMarkerSymbol");
    dojo.require("esri.Color");
    dojo.require("esri/dijit/OverviewMap");

    esri.config.defaults.io.corsDetection = true;
    esri.config.defaults.map.panDuration = 100;
    esri.config.defaults.map.panRate = 1;
    esri.config.defaults.map.zoomDuration = 100;
    esri.config.defaults.zoomRate = 1;


    var map = null;//地图对象
    var streetLayer = null;//地图底图
    var ImgLayer = null;
    var nightLayer = null;

    var tollgateclusterLayer = null;
    var videoclusterLayer = null;


    /*
     * 图层数组
     * [1,2,3,4]
     * 卡口，视频，案件，警情
     *
     * 卡口类型[78,79,80,81,82]
     *  WIFI探针卡口,人脸卡口,治安卡口  ,交通卡口,其他
     * */
    var tollgateLayer = null;//卡口图层
    var videoLayer = null;//视频图层
    var caseInfoLayer = null;//案件图层
    var warnInfoLayer = null;//警情图层

    var positioningLayer = null;//定位图层

    var whetherTheLoading = true;

    //地图页面汇点使用数据
    var tollgateArr = [];
    var videoArr = [];
    var caseInfoArr = [];
    var warnInfoArr = [];

    //返回页面的数据
    var businessTollgateArr = [];
    var businessCameraArr = [];
    var businessCaseInfoArr = [];
    var businessWarnInfoArr = [];

    //定位样式
    var arraySymbol = new esri.symbols.SimpleMarkerSymbol(
        {
            "color": new esri.Color([255, 0, 0]),
            "style": "Square",
            "type": "esriSMS",
            "xoffset": 0,
            "yoffset": 0
        }
    );

    var urlcenterPoint = "/systemManage/mapMaintain/initCenter";
    var urlcameraList = "/videoManage/camera/cameraList";
    var urltollgateList = "/systemManage/tollgate/viewTollgateList";
    /*==============================================================*/
    var urlWarnInfoList = "/systemManage/warnInfo/warnInfoManage";
    var urlCaseInfoList = "/caseCenter/caseManage/getCaseInfoList";
    //测量地图使用的
    var measureTool = null;
    var measureHanlder = null;
    var drawToolBar = null;//地图toollbar
    var _cPoint = null;//加载完地图后的中心节点
    var _defaultZoomLevel = 12;//默认层级
    var currentPageObject;
    var objectId;
    var drawEndHandler;
    var optionDefault={
        initCamera:true
    };
    /*==============================================================*/
    var displayTutzenData = {};
    var _initMap = function (mapElement, obj, Layer,option) {
        require(["esri/dijit/OverviewMap","extras/ClusterLayer",
                "esri/layers/WebTiledLayer", "extras/ArcGISWebTiledLayer",
                "esri/geometry/Extent", "esri/SpatialReference","esri/layers/TileInfo",
                "dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
            "esri/renderers/ClassBreaksRenderer","esri/symbols/SimpleLineSymbol",
                "esri/Color","esri/geometry/webMercatorUtils"],
            function (OverviewMap,ClusterLayer,
                      WebTiledLayer, ArcGISTiledLayer,
                      Extent, SpatialReference, TileInfo,
                      arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,SimpleLineSymbol,Color,webMercatorUtils) {
            map = new esri.map(mapElement, {
                autoResize: true,
                isClickRecenter:false,
                logo: false,
                maxZoom:ConfigSetting.MapNightMaxLevel * 1,
                minZoom:ConfigSetting.MapNightMinLevel * 1,
                fadeOnZoom: true,
                fitExtent: true,
                isDoubleClickZoom: true,
            });
                mapSatialReference = new SpatialReference(mapSatialReference);
                objectId = "#"+mapElement;
                // map.on("extent-change", showExtent);
                // function showExtent(ext){
                //     var extentString = "";
                //     extentString = "XMin: " + ext.extent.xmin +
                //         " YMin: " + ext.extent.ymin +
                //         " XMax: " + ext.extent.xmax +
                //         " YMax: " + ext.extent.ymax;
                // }
                displayTutzenData = Layer;

            if(option){
                optionDefault = $.extend(optionDefault,option);
            }
            map.on("load", function () {
                var nowMap = this;
                    // var startExtent = new Extent(119.42253812669179, 31.598889095809767, 119.45604093765388, 31.612556719827253,
                    //     map.spatialReference );
                    // map.setExtent(startExtent);
                    nowMap.disableDoubleClickZoom();
                    nowMap.disableClickRecenter();
                //初始化设置高度
                dojo.connect(map, "onZoomEnd", function (extent, zoomFactor, anchor) {
                    var level = map.getLevel();
                    if (level <= mapLevelAggregation) {
                        showPoint(false);
                    } else {
                        showPoint(true);
                    }
                });
                //设置中心节点
                $.post(urlcenterPoint, function (data) {
                    if (data.state == "SUCCESS") {
                        if (data.rows.length > 0) {
                            var rowdata = data.rows[0];
                            var cPoint;
                            mapCenterPointVal={x:rowdata.longitude,y:rowdata.latitude};
                            if(ConfigSetting.MapNightisWebMercator == "true"){
                                var normalizedVal = webMercatorUtils.lngLatToXY(rowdata.longitude, rowdata.latitude);
                                cPoint = new esri.geometry.Point(normalizedVal[0], normalizedVal[1],mapSatialReference);
                            }else{
                                cPoint = new esri.geometry.Point(rowdata.longitude, rowdata.latitude,mapSatialReference);
                            }
                            nowMap.centerAndZoom(cPoint, rowdata.mapLevel);
                            if (rowdata.mapLevel <= mapLevelAggregation) {
                                showPoint(false);
                            } else {
                                showPoint(true);
                            }
                            _cPoint = cPoint;
                        }else{
                            if (nowMap.getLevel() <= mapLevelAggregation) {
                                showPoint(false);
                            } else {
                                showPoint(true);
                            }
                        }
                    }
                }, "json");
                if (showToolBar()) {
                    initToolBar(mapElement);
                    _initMapToolbar();
                }
            });
            drawToolBar = null;
            currentPageObject = obj;
            //初始化底图h
            if(ConfigSetting.MapServiceContract == "WebTiledLayer"){
                var mapParam = {};
                $.ajaxSettings.async = false;
                $.get("/js/MapInfoParams.json", function (param) {
                    mapParam = param;
                    if (!mapParam) {
                        alert("请正确配置参数！");
                        return;
                    }else{
                        var fullExtent = new Extent(mapParam.fullExtent.xmin, mapParam.fullExtent.ymin, mapParam.fullExtent.xmax, mapParam.fullExtent.ymax, new SpatialReference({ 'wkid': mapParam.fullExtent.wkid }));
                        var initialExtent = new Extent(mapParam.initialExtent.xmin, mapParam.initialExtent.ymin, mapParam.initialExtent.xmax, mapParam.initialExtent.ymax, new SpatialReference({ 'wkid': mapParam.initialExtent.wkid }));
                        var tileInfo=new TileInfo({
                            rows: mapParam.rows,
                            cols: mapParam.cols,
                            compressionQuality: mapParam.compressionQuality,
                            origin: mapParam.origin,
                            spatialReference: new SpatialReference({ 'wkid': mapParam.wkid }),
                            lods: mapParam.lods
                        });
                        var options = {
                            "fullExtent": fullExtent,
                            "initialExtent": initialExtent,
                            "tileInfo": tileInfo
                        };
                        streetLayer = new ArcGISTiledLayer(ConfigSetting.MAP_NIGHT_URL,options);
                        map.addLayer(streetLayer,0);
                    }
                });


            }else if(ConfigSetting.MapServiceContract == "ArcgisRest"){
                streetLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_NIGHT_URL, {id: "streetLayer"});
                map.addLayer(streetLayer, 0);
                var nationalMap = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_NATIONAL_URL, {id: "nationalLayer"});
                map.addLayer(nationalMap,0);
                nationalMap.hide();
            }
            $.ajaxSettings.async = true;
            var overviewMapDijit = new esri.dijit.OverviewMap({
                map: map, // 必要的
                visible: true,    // 初始化可见，默认为false
                attachTo: "bottom-left", // 默认右上角
                width: 310,   // 默认值是地图高度的 1/4th
                height: 200, // 默认值是地图高度的 1/4th
                // opacity: 0.,  // 透明度 默认0.5
                maximizeButton: false, // 最大化,最小化按钮，默认false
                // expandFactor: 0.4,    //概览地图和总览图上显示的程度矩形的大小之间的比例。默认值是2，这意味着概览地图将至少是两倍的大小的程度矩形。
                // color: "red"  // 默认颜色为#000000
            });
            overviewMapDijit.startup();
            tollgateLayer = new esri.layers.GraphicsLayer({id: "tollgateLayer"});
            map.addLayer(tollgateLayer);
            videoLayer = new esri.layers.GraphicsLayer({id: "videoLayer"});
            map.addLayer(videoLayer, 2);
            caseInfoLayer = new esri.layers.GraphicsLayer({id: "caseInfoLayer"});
            map.addLayer(caseInfoLayer, 3);
            warnInfoLayer = new esri.layers.GraphicsLayer({id: "warnInfoLayer"});
            map.addLayer(warnInfoLayer, 4);
            ImgLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_IMAGE_URL, {id: "ImgLayer"});
            map.addLayer(ImgLayer, 5);
            ImgLayer.setVisibility(false);
            nightLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_NIGHT_URL, {id: "nightLayer"});
            map.addLayer(nightLayer, 6);
            nightLayer.setVisibility(false);
            getData();
        });

        return map;
    };
    var showPoint = function (flag) {
        if (flag) {
            $(objectId+" #LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);

                layer.show();
                if (videoclusterLayer != null) {
                    videoclusterLayer.setVisibility(false);
                }
                if(tollgateclusterLayer!=null){
                    tollgateclusterLayer.setVisibility(false);
                }
            });


        } else {
            $(objectId+" #LayerSearchContent .drawtoolDiv").find("input").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                layer.hide();
            });
            $(objectId+" #LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                if(layerId == "videoLayer"){
                    if(videoclusterLayer!=null){
                        videoclusterLayer.setVisibility(true);
                    }
                }
                if(layerId == "tollgateLayer"){
                    if(tollgateclusterLayer!=null){
                        tollgateclusterLayer.setVisibility(true);
                    }
                }
            });
    }
    };

    var cleraLayerForMap = function () {

    };
    var drawPictureLayerForMap = function () {
        if (tollgateArr.length > 0) {
            drawTollgateLayer(tollgateArr);
        }
        if (videoArr.length > 0) {
            drawVideoLayer(videoArr);
        }
    };

    //初始化地图工具栏
    var _initMapToolbar = function () {
        require(["esri/geometry/Point"], function (Point) {
            var index = 1;
            /*漫游*/
            $(objectId+" #Pan").off().on("click", function () {
                //注销测距工具
                if (measureTool && !measureTool._destroyed) {
                    measureTool.destroy();
                    $(objectId+" #measurePanel").hide();
                }
                //注销绘制工具
                if (drawToolBar) {
                    drawToolBar.deactivate();
                }
            });
            /*测距*/
            $(objectId+" #Measure").click(function () {
                __startMeasure();
            });
            /*全图*/
            $(objectId+" #FullExtent").click(function () {
                if (_cPoint != null) {
                    map.centerAndZoom(_cPoint, _defaultZoomLevel);
                }
            });
            /*影像*/
            $(objectId+" #image").click(function () {
                var imageLayer = map.getLayer("ImgLayer");
                if (imageLayer) {
                    imageLayer.setVisibility(!imageLayer.visible);
                }
            });
            //绘制查询
            $(objectId+" .toolDiv").click(function (evt) {
                var id = $(this).attr("id");
                map.infoWindow.hide();
                switch (id) {
                    //矩形
                    case "rectTool":
                        __mapDrawSearch("Rectangle");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //多边形
                    case "polygonTool":
                        __mapDrawSearch("Polygon");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //圆形
                    case "bufferTool":
                        __mapDrawSearch("Circle");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //清除
                    case "clearTool":
                        //清空绘制图层数据
                        var drawLayer = map.getLayer("drawLayer");
                        $(this).parent(".toolH").siblings().removeClass("selected");
                        if (drawLayer) {
                            drawLayer.clear();
                            $(objectId+" #bayonetresults").hide();
                        }
                        businessTollgateArr = [];
                        businessCameraArr = [];
                        businessCaseInfoArr = [];
                        businessWarnInfoArr = [];
                        if (currentPageObject.getDrawHandlerResult && typeof(currentPageObject.getDrawHandlerResult) == "function") {
                            currentPageObject.getDrawHandlerResult(businessTollgateArr, businessCameraArr, businessCaseInfoArr, businessWarnInfoArr,true)
                        }
                        // if (currentPageObject.getclearTool && typeof(currentPageObject.getclearTool) == "function") {
                        //     currentPageObject.getclearTool()
                        // }
                        //注销测距工具
                        if (measureTool && !measureTool._destroyed) {
                            measureTool.destroy();
                            $(objectId+" #measurePanel").hide();
                            $(objectId+" #measurePanel").hide().html("");
                        }
                        //注销绘制工具
                        if (drawToolBar) {
                            drawToolBar.deactivate();
                        }
                        /*清除已选卡口*/
                        break;
                    default:
                        break;
                }

            });

            /*工具条下拉*/
            $(objectId+" #DrawSearchBtn").click(function (e) {
                e.stopPropagation();
                $(this).parent().parent().siblings().find(".extentTools").hide();
                $(this).parent().parent().siblings().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                $(this).parent().find(".extentTools").toggle();
                if ($(this).parent().find(".toolexpand").attr("src") == "/images/map/toolbar/down-hover.png") {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/up-hover.png");
                }
                else {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/down-hover.png");
                }




                //点击页面其他位置收起工具条下拉
                $(document).click(function () {
                    $(".toolexpand").each(function () {
                        if ($(this).attr("src") == "/images/map/toolbar/up.png") {
                            $(this).parent().click();
                        }
                    });
                });
            });
            /*图层下拉*/
            $(objectId+" #LayerSearch").click(function (e) {
                e.stopPropagation();
                $(this).parent().parent().siblings().find(".extentTools").hide();
                $(this).parent().parent().siblings().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                $(this).parent().find(".extentTools").toggle();
                if ($(this).parent().find(".toolexpand").attr("src") == "/images/map/toolbar/down-hover.png") {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/up-hover.png");
                }
                else {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/down-hover.png");
                }
                //点击页面其他位置收起工具条下拉
                $(document).click(function () {
                    $(".toolexpand").each(function () {
                        if ($(this).attr("src") == "/images/map/toolbar/up.png") {
                            $(this).parent().click();
                        }
                    });
                });
            });
            $(objectId+" #LayerSearchContent").off().on("click", function (e) {
                e.stopPropagation();
            });
            $("input[name='checkbox']").change(function (e) {
                var layerId = $(this).attr("layerId");
                var flag = this.checked;
                changeLayer(layerId, flag);
            })

        });
        //添加hover样式
        // 矩形
        $("#drawRect").hover(function(){
            $(this).attr("src","/images/map/toolbar/rect-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/rect.png")
        });
        //多边形
        $("#drawPolygon").hover(function(){
            $(this).attr("src","/images/map/toolbar/polygon-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/polygon.png")
        });
        //圆形
        $("#drawBuffer").hover(function(){
            $(this).attr("src","/images/map/toolbar/round-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/round.png")
        });
        //清除
        $("#drawClear").hover(function(){
            $(this).attr("src","/images/map/toolbar/clear-hover.png")
        },function(){
            $(this).attr("src","/images/map/toolbar/clear.png")
        });
        //图层切换
        //判断小箭头状态 双判断
        //更改了上面点击的判断  /*图层下拉*/
        $("#LayerSearchBtn").hover(function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers-hover.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers-hover.png")
            }
        },function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/layers.png")
            }
        });
        //地图其他操作
        //判断小箭头状态 双判断
        // 更改了上面点击的判断 /*工具条下拉*/
        $("#DrawSearchBtn").hover(function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw-hover.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up-hover.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw-hover.png")
            }
        },function(){
            if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/down-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/down.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw.png")
            }else if($(this).find("img.toolexpand").attr("src") == "/images/map/toolbar/up-hover.png" ){
                $(this).find("img.toolexpand").attr("src","/images/map/toolbar/up.png")
                $(this).find("img.expandSlib").attr("src","/images/map/toolbar/draw.png")
            }
        });
        // 地图其他操作的三个小图标
        //测距
        $("#Measure").hover(function(){
            $(this).find("img").attr("src","/images/map/toolbar/measure-hover.png")
        },function(){
            $(this).find("img").attr("src","/images/map/toolbar/measure.png")
        });
        //全图
        $("#FullExtent").hover(function(){
            $(this).find("img").attr("src","/images/map/toolbar/fullextent-hover.png")
        },function(){
            $(this).find("img").attr("src","/images/map/toolbar/fullextent.png")
        });
        //影像
        $("#image").hover(function(){
            $(this).find("img").attr("src","/images/map/toolbar/image-hover.png")
        },function(){
            $(this).find("img").attr("src","/images/map/toolbar/image.png")
        });
    };
    /*显示隐藏图层*/
    function changeLayer(layerId, flag) {
        var layer = map.getLayer(layerId);
        var level = map.getLevel();
        if (level <= mapLevelAggregation) {
            if (flag) {
                if (layerId == "videoLayer") {
                    if (videoclusterLayer != null) {
                        videoclusterLayer.setVisibility(true);
                    }
                }
                if (layerId == "tollgateLayer") {
                    if (tollgateclusterLayer != null) {
                        tollgateclusterLayer.setVisibility(true);
                    }
                }
            } else {
                if (layerId == "videoLayer") {
                    if (videoclusterLayer != null) {
                        videoclusterLayer.setVisibility(false);
                    }
                }
                if (layerId == "tollgateLayer") {
                    if (tollgateclusterLayer != null) {
                        tollgateclusterLayer.setVisibility(false);
                    }
                }
            }
        }else{

            if (flag) {
                layer.show();
            } else {
                layer.hide();
            }
        }
    }

    //end 轨迹
    var __startMeasure = function () {
        require(["esri/geometry/Polyline", "esri/geometry/Point", "esri/dijit/Measurement", "esri/units"],
            function (Polyline, Point, Measurement, units) {
                var customPolyline = new Polyline();
                customPolyline.addPath([
                    new Point(0, 0,mapSatialReference),
                    new Point(0, 0,mapSatialReference),
                    new Point(0, 0,mapSatialReference)
                ]);
                if (!measureTool || measureTool._destroyed) {
                    measureTool = Measurement({
                        map: map,
                        geometry: customPolyline,
                        defaultLengthUnit: units.METERS
                    });
                }
                if (measureHanlder) {
                    measureHanlder.remove();
                }
                measureTool.startup();
                $(objectId+" #measurePanel").show();
                measureHanlder = measureTool.on("measure", function (evt) {
                    var result = evt.values;
                    $(objectId+" #measurePanel").text("距离：" + result.toFixed(2) + "米");
                });
            });
    };
    //地图图形查询
    var __mapDrawSearch = function (geometryType) {
        require(["esri/toolbars/draw", "esri/graphic", "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
                "esri/layers/GraphicsLayer", "esri/Color", "esri/geometry/webMercatorUtils", "esri/tasks/query",
                "esri/tasks/QueryTask", "esri/tasks/IdentifyTask", "esri/tasks/IdentifyParameters"],
            function (Draw, Graphic, SimpleFillSymbol, SimpleLineSymbol, GraphicsLayer, Color, webMercatorUtils, Query, QueryTask, IdentifyTask, IdentifyParameters) {
                //每次绘制前，清空已绘制图形
                var drawLayer = map.getLayer("drawLayer");
                if (drawLayer) {
                    drawLayer.clear();
                    $(objectId+" #bayonetresults").hide();
                    $(objectId+" .toolH").removeClass("selected");
                } else {
                    drawLayer = new GraphicsLayer({"id": "drawLayer"});
                    map.addLayer(drawLayer);
                }

                //防止开始绘制前多次绑定绘制完成的方法
                if (drawEndHandler) {
                    dojo.disconnect(drawEndHandler);
                }
                //防止开始绘制前多次初始化绘制工具
                if (drawToolBar) {
                    drawToolBar.deactivate();
                }
                else {
                    drawToolBar = new Draw(map);
                }
                switch (geometryType) {
                    case "Rectangle":
                        drawToolBar.activate(esri.toolbars.Draw.RECTANGLE);
                        break;
                    case "Polygon":
                        drawToolBar.activate(esri.toolbars.Draw.POLYGON);
                        break;
                    case "Circle":
                        drawToolBar.activate(esri.toolbars.Draw.CIRCLE);
                        break;
                    case "Polyline":
                        drawToolBar.activate(esri.toolbars.Draw.POLYLINE);
                        break;
                    default:
                        break;
                }
                drawEndHandler = dojo.connect(drawToolBar, "onDrawEnd", function (geometry) {
                    dojo.disconnect(drawEndHandler);
                    //清除选中状态 清除地图圈选范围
                    $(objectId+" .toolH").siblings().removeClass("selected");
                    //清空数据
                    businessTollgateArr = [];
                    businessCameraArr = [];
                    businessCaseInfoArr = [];
                    businessWarnInfoArr = [];
                    var symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]));
                    var graphic = new Graphic(geometry, symbol);
                    drawLayer.add(graphic);
                    drawToolBar.deactivate();
                    var selectArr = [];
                    $(objectId+" #LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                        var layerId = $(this).attr("layerId");
                        var layer = map.getLayer(layerId);
                        if (layer.visible) {
                            for (var i = 0, c = layer.graphics.length; i < c; i++) {
                                if(ConfigSetting.MapNightisWebMercator == "true"){
                                    var p = webMercatorUtils.webMercatorToGeographic(layer.graphics[i].geometry);
                                }else{
                                    var p = layer.graphics[i].geometry
                                }
                                if (geometry.contains(p)) {
                                    selectArr.push(layer.graphics[i]);
                                }
                            }
                        }
                    })
                    for (var i = 0; i < selectArr.length; i++) {
                        if (selectArr[i].attributes.species == "tollgate") {
                            businessTollgateArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "camera") {
                            businessCameraArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "caseInfo") {
                            businessCaseInfoArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "warnInfo") {
                            businessWarnInfoArr.push(selectArr[i])
                        }
                    }
                    if (currentPageObject.getDrawHandlerResult && typeof(currentPageObject.getDrawHandlerResult) == "function") {
                        currentPageObject.getDrawHandlerResult(businessTollgateArr, businessCameraArr, businessCaseInfoArr, businessWarnInfoArr)
                    }
                });
            });
    };
    var clearDraw = function () {

    };

    function getData() {
        require(["esri/dijit/OverviewMap","extras/ClusterLayer",
                "dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
                "esri/renderers/ClassBreaksRenderer","esri/symbols/SimpleLineSymbol",
                "esri/Color","esri/geometry/webMercatorUtils"],
            function (OverviewMap,ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,SimpleLineSymbol,Color,webMercatorUtils) {
                if (displayTutzenData.tollgate.length > 0) {
                    $.post(urltollgateList, {tollgateType: displayTutzenData.tollgate.join(",")}, function (tollgateData) {
                        tollgateArr = [];
                        if (tollgateData && tollgateData.state == "SUCCESS") {
                            var tollgateList = tollgateData.rows;
                            tollgateArr = tollgateList.filter(function (o, i) {
                                o.id = i;
                                o.dataId = o.tollgateId;
                                o.text = o.tollgateName;
                                o.x = o.longitude;
                                o.y = o.latitude;
                                o.name = o.tollgateName;
                                o.attributes =  {
                                    "x":o.longitude,
                                    "y":o.latitude,
                                    "name":o.tollgateName
                                };
                                return true;
                            });
                            var countyInfo = {};
                            countyInfo.data = arrayUtils.map(tollgateArr, function(item) {
                                var webMercator;
                                if(ConfigSetting.MapNightisWebMercator == "true"){
                                     webMercator = webMercatorUtils.geographicToWebMercator(new Point(parseFloat(item.x), parseFloat(item.y), mapSatialReference));
                                }else{
                                     webMercator = {"x":item.x, "y": item.y}
                                }
                                // var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                                // var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                                var attributes = {
                                    "名称": item.name,
                                    "经度": item.x,
                                    "纬度": item.y
                                };
                                return {
                                    "x": webMercator.x,
                                    "y": webMercator.y,
                                    "attributes": attributes
                                };
                            });
                            tollgateclusterLayer = new ClusterLayer({
                                "data": countyInfo.data,
                                "distance": 150,
                                "id": "clusterstollgate",
                                "labelColor": "#027ebd",
                                "labelOffset": 13,
                                // "resolution": map.extent.getWidth() / map.width,
                            });
                            var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                            var blue = new esri.symbols.PictureMarkerSymbol("/images/icons/kkjh.png", 54, 32).setOffset(0, 15);
                             renderer.addBreak(0, tollgateArr.length, blue);
                             tollgateclusterLayer.setRenderer(renderer);
                            map.addLayer(tollgateclusterLayer);
                            tollgateclusterLayer.setVisibility(false);
                            drawTollgateLayer(tollgateArr);
                        }
                    }, "json");
                }
                if (displayTutzenData.video&&optionDefault.initCamera) {
                    $.post(urlcameraList, function (tollgateData) {
                        videoArr = [];
                        if (tollgateData && tollgateData.state == "SUCCESS") {
                            var tollgateList = tollgateData.rows;
                            videoArr = tollgateList.filter(function (o, i) {
                                o.id = i;
                                o.dataId = o.cameraId;
                                o.text = o.cameraName;
                                o.x = o.longitude;
                                o.y = o.latitude;
                                o.name = o.cameraName;
                                o.attributes =  {
                                    "x":o.longitude,
                                    "y":o.latitude,
                                    "name":o.cameraName
                                };
                                return true;
                            });
                            var countyInfoVideo = {};
                            countyInfoVideo.data = arrayUtils.map(videoArr, function(item) {
                                var webMercator;
                                if(ConfigSetting.MapNightisWebMercator == "true"){
                                    webMercator = webMercatorUtils.geographicToWebMercator(new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference));
                                }else{
                                    webMercator = {"x":item.x, "y": item.y}
                                }
                                // var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                                // var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                                var attributes = {
                                    "名称": item.name,
                                    "经度": item.x,
                                    "纬度": item.y
                                };
                                return {
                                    "x": webMercator.x,
                                    "y": webMercator.y,
                                    "attributes": attributes
                                };
                            });
                            videoclusterLayer = new ClusterLayer({
                                // "data": countyInfoVideo.data,
                                // "distance": 150,
                                // "id": "clustersvideo",
                                // "labelColor": "#027ebd",
                                // "labelOffset": 13,
                                // "resolution": map.extent.getWidth() / map.width,
                                // "singleColor": "#f00",
                                // "maxSingles":3000
                            });
                            var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                            var green = new esri.symbols.PictureMarkerSymbol("/images/icons/spjh.png", 54, 32).setOffset(0, 15);
                            renderer.addBreak(0, videoArr.length, green);
                            videoclusterLayer.setRenderer(renderer);
                            map.addLayer(videoclusterLayer);
                            videoclusterLayer.setVisibility(false);
                            drawVideoLayer(videoArr);
                        }
                    }, "json");
                }
                // if (displayTutzenData.warnInfo) {
                //     $.post(urlWarnInfoList, function (tollgateData) {
                //         warnInfoArr = [];
                //         if (tollgateData && tollgateData.state == "SUCCESS") {
                //             var alarmList = tollgateData.rows;
                //             for (j  in alarmList) {
                //                 warnInfoArr.push({
                //                     dataId: alarmList[j].warnId,
                //                     text: alarmList[j].warnTitle,
                //                 });
                //             }
                //             warnInfoArr = warnInfoArr.filter(function (o, i) {
                //                 o.id = i;
                //                 return true;
                //             });
                //         }
                //     }, "json");
                // }
                // if (displayTutzenData.case) {
                //     $.post(urlCaseInfoList, function (tollgateData) {
                //         caseInfoArr = [];
                //         if (tollgateData && tollgateData.state == "SUCCESS") {
                //             var tollgateList = tollgateData.rows;
                //             caseInfoArr = tollgateList.filter(function (o, i) {
                //                 o.id = i;
                //                 o.dataId = o.caseId;
                //                 o.text = o.caseName;
                //                 return true;
                //             });
                //         }
                //     }, "json");
                // }
        })



    }

    function initToolBar(mapEl) {
        $("#" + mapEl).append($("#mapToolbar").html());
        if (displayTutzenData.tollgate.length == 0) {
            $(objectId+" #selDivPan .showcasing.tollgate").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.tollgate").remove();
        }
        if (!displayTutzenData.video) {
            $(objectId+" #selDivPan .showcasing.video").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.video").remove();
        }
        if (!displayTutzenData.case) {
            $(objectId+" #selDivPan .showcasing.case").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.caseInfo").remove();
        }
        if (!displayTutzenData.warnInfo) {
            $(objectId+" #selDivPan .showcasing.alarm").remove();
            $(objectId+" #LayerSearchContent .drawtoolDiv.warnInfo").remove();
        }
        $(objectId+" #mapLocate").off().on("click", function () {
            if ($(objectId+" .card").hasClass("animated-card")) {
                $(objectId+" #selHidden").hide();
                $(objectId+" .selected").removeClass("selectedSel2");
                $(objectId+" .card").removeClass("animated-card");
            } else {
                $(objectId+" .card").addClass("animated-card");
                $(objectId+" .showcasing").removeClass("selectedSel2");
            }
        });
        $(objectId+" .showcasing").off().on("click", function () {
            if ($(this).hasClass("selectedSel2")) {
                $(objectId+" #selHidden").hide();
                $(this).removeClass("selectedSel2");
            } else {
                $(objectId+" .showcasing").removeClass("selectedSel2");
                $(objectId+" #selHidden").show();
                $(this).addClass("selectedSel2");
                if ($(this).hasClass("tollgate")) {
                    bindData("卡口", tollgateArr);
                }
                if ($(this).hasClass("video")) {
                    bindData("视频", videoArr);
                }
                if ($(this).hasClass("case")) {
                    bindData("案件", caseInfoArr);
                }
                if ($(this).hasClass("alarm")) {
                    bindData("警情", warnInfoArr);
                }
            }
        });
    }

    function bindData(text, dataArr) {
        require(["esri/geometry/webMercatorUtils"],
            function (webMercatorUtils) {
                $(objectId+" #selTollgate").empty().off("change");
                $(objectId+" #selTollgate").select2({
                    placeholder: "请输入" + text + "名称",
                    allowClear: true,
                    multiple: false,
                    data: dataArr,
                    width: null
                }).val(null).trigger("change").on("change", function (e) {
                    var val = $(objectId+" #selTollgate").val();
                    if (val == null) {
                        return;
                    }
                    positioningLayer = map.getLayer("positioningLayer");
                    if (positioningLayer != null) {
                        positioningLayer.clear();
                    } else {
                        positioningLayer = new esri.layers.GraphicsLayer({id: "positioningLayer"});
                        map.addLayer(positioningLayer);
                    }
                    if (dataArr[val].longitude != 0 && dataArr[val].longitude != '' && dataArr[val].longitude != null) {
                        var cPoint;
                        if(ConfigSetting.MapNightisWebMercator == "true"){
                            var normalizedVal = webMercatorUtils.lngLatToXY(dataArr[val].longitude, dataArr[val].latitude);
                            cPoint = new esri.geometry.Point(normalizedVal[0], normalizedVal[1],mapSatialReference);
                        }else{
                            cPoint = new esri.geometry.Point(dataArr[val].longitude,dataArr[val].latitude,mapSatialReference);
                        }
                        var alarm_g = new esri.Graphic(cPoint);
                        alarm_g.setSymbol(arraySymbol);
                        positioningLayer.add(alarm_g);
                        /*如果当前为聚合状态,放大到聚合层级+1;如果为展开状态,不用放大层级*/
                        var nowLevel = map.getLevel();
                        var level = (nowLevel>ConfigSetting.MapNightClusterLayer?nowLevel:(ConfigSetting.MapNightClusterLayer-0+1));
                        map.centerAndZoom(cPoint,level);
                        $(positioningLayer.getNode()).animate({opacity: 0}, 600).animate({opacity: 0.8}, 600).animate({opacity: 0}, 600).animate({opacity: 1}, 600, function () {
                            positioningLayer.clear();
                        });
                        if (currentPageObject.accessToLocate && typeof(currentPageObject.accessToLocate) == "function") {
                            currentPageObject.accessToLocate(dataArr[val])
                        }
                    } else {
                        common.showWarn("点位坐标未配置", "提示")
                    }
                }).on("select2:open",function(){
                    $(objectId+" #selTollgate").val(-1);
                });
            });

    }

    function showToolBar() {
        var flag = false;
        if (displayTutzenData.tollgate.length > 0 || displayTutzenData.video || displayTutzenData.warnInfo || displayTutzenData.case) {
            flag = true;
        }
        return flag;
    }

    var drawTollgateLayer = function (data) {
        require(["esri/geometry/webMercatorUtils"],
            function (webMercatorUtils) {
                if (tollgateLayer) {
                    tollgateLayer.clear();
                }
                for (var i = 0; i < data.length; i++) {
                    var alarm_x = data[i].longitude;
                    var alarm_y = data[i].latitude;
                    var alarm_type = data[i].tollgateType;
                    var alarm_attr = {
                        "name": data[i].tollgateName,
                        "id": data[i].tollgateId,
                        "type": data[i].tollgateType,
                        "species": "tollgate",
                        "longitude": data[i].longitude,
                        "latitude": data[i].latitude,
                        "states": ""
                    };
                    var webMercator;
                    if(ConfigSetting.MapNightisWebMercator == "true"){
                        webMercator = webMercatorUtils.lngLatToXY(alarm_x, alarm_y);
                    }else{
                        webMercator =[alarm_x, alarm_y];
                    }
                    // var alarm_p = new Point(webMercator[0], webMercator[1],mapSatialReference);
                    // var alarm_g = new esri.Graphic(alarm_p);
                    var alarm_g = new esri.Graphic(new esri.geometry.Point(webMercator[0], webMercator[1],mapSatialReference));

                    alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/tollgate/gis"+alarm_type+".png", 26, 34).setOffset(0,16));

                    tollgateLayer.add(alarm_g);
                    alarm_g.setAttributes(alarm_attr);
                }
            })

    };
    var drawVideoLayer = function (data) {
        require(["esri/geometry/webMercatorUtils"],
            function (webMercatorUtils) {
                if (videoLayer) {
                    videoLayer.clear();
                }
                for (var i = 0; i < data.length; i++) {
                    var alarm_x = data[i].longitude;
                    var alarm_y = data[i].latitude;
                    var alarm_states = data[i].status;
                    var alarm_type = data[i].cameraType;
                    var alarm_attr = {
                        "name": data[i].cameraName,
                        "id": data[i].cameraId,
                        "type": data[i].cameraType,
                        "species": "camera",
                        "longitude": data[i].longitude,
                        "latitude": data[i].latitude,
                        "states": data[i].status,
                        "playCtrl":data[i].playControl
                    };
                    var webMercator;
                    if(ConfigSetting.MapNightisWebMercator == "true"){
                        webMercator = webMercatorUtils.lngLatToXY(alarm_x, alarm_y);
                    }else{
                        webMercator =[alarm_x, alarm_y]
                    }
                    // var alarm_p = new Point(webMercator[0], webMercator[1],mapSatialReference);
                    // var alarm_g = new esri.Graphic(alarm_p);
                    var alarm_g = new esri.Graphic(new esri.geometry.Point(webMercator[0], webMercator[1],mapSatialReference));
                    // if (alarm_states == "0" && alarm_type == "1") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/shootingGis.png", 26, 34));
                    // }
                    // if (alarm_states == "1" && alarm_type == "1") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/shootingFailureGis.png", 26, 34));
                    // }
                    // if (alarm_states == "0" && alarm_type == "2") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/skillGis.png", 26, 34));
                    // }
                    // if (alarm_states == "1" && alarm_type == "2") {
                    //     alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/skillFailureGis.png", 26, 34));
                    // }
                    alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/camera/gis"+alarm_type+(alarm_states==1?"_off":"")+".png", 26, 34).setOffset(0,16));
                    videoLayer.add(alarm_g);
                    alarm_g.setAttributes(alarm_attr);
                }
            });

    };
    var drawCaseInfoLayer = function (data) {

        if (caseInfoLayer != null) {
            caseInfoLayer.clear();
        }
        ;
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longitude;
            var alarm_y = data[i].latitude;
            var alarm_attr = {
                "name": data[i].caseName,
                "id": data[i].caseNo,
                "type": "",
                "species": "caseInfo",
                "longitude": data[i].longitude,
                "latitude": data[i].latitude,
                "states": "",
                "time": data[i].startTime
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y,map.spatialReference));
            alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/caseGis.png", 20, 20));
            caseInfoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }

    };
    var drawWarnInfoLayer = function (data) {
        if (warnInfoLayer != null) {
            warnInfoLayer.clear();
        }
        ;
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longtitude;
            var alarm_y = data[i].latitude;
            var alarm_attr = {
                "name": data[i].warnTitle,
                "id": data[i].warnId,
                "species": "warnInfo",
                "longitude": data[i].longtitude,
                "latitude": data[i].latitude,
                "states": "",
                "time": data[i].warnTime
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y,map.spatialReference));
            alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/alarmLocation.png", 20, 20));
            warnInfoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }
    };
    var updateVideoArr = function(arr){
        require(["extras/ClusterLayer","dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
                "esri/renderers/ClassBreaksRenderer","esri/geometry/webMercatorUtils"],
            function (ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,webMercatorUtils) {
                videoArr = arr.filter(function (o, i) {
                    o.id = i;
                    o.dataId = o.cameraId;
                    o.text = o.cameraName;
                    o.x = o.longitude;
                    o.y = o.latitude;
                    o.name = o.cameraName;
                    o.attributes = {
                        "x": o.longitude,
                        "y": o.latitude,
                        "name": o.cameraName
                    };
                    return true;
                });
                var countyInfoVideo = {};
                countyInfoVideo.data = arrayUtils.map(videoArr, function (item) {
                    var webMercator;
                    if(ConfigSetting.MapNightisWebMercator == "true"){
                        webMercator = webMercatorUtils.geographicToWebMercator(new Point(parseFloat(item.x), parseFloat(item.y), mapSatialReference));
                    }else{
                        webMercator = {"x":item.x, "y": item.y}
                    }
                    // var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                    // var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                    var attributes = {
                        "名称": item.name,
                        "经度": item.x,
                        "纬度": item.y
                    };
                    return {
                        "x": webMercator.x,
                        "y": webMercator.y,
                        "attributes": attributes
                    };
                });
                videoclusterLayer = new ClusterLayer({
                    "data": countyInfoVideo.data,
                    "distance": 150,
                    "id": "clustersvideo",
                    "labelColor": "#027ebd",
                    "labelOffset": 13,
                    "resolution": map.extent.getWidth() / map.width,
                    // "singleColor": "#f00",
                    // "maxSingles":3000
                });
                var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                var green = new esri.symbols.PictureMarkerSymbol("/images/icons/spjh.png", 54, 32).setOffset(0, 15);
                renderer.addBreak(0, videoArr.length, green);
                videoclusterLayer.setRenderer(renderer);
                map.addLayer(videoclusterLayer);
                videoclusterLayer.setVisibility(false);
                drawVideoLayer(videoArr);
            })
    }
    return {
        init: function (mapElement, obj, Layer,option) {
            // console.debug("调试地图功能");
            return _initMap(mapElement, obj, Layer,option);
        },
        getMap: function () {
            return map;
        },
        setCaseInfoArr: function (arr) {
            caseInfoArr = arr.filter(function (o, i) {
                o.id = i;
                o.dataId = o.caseId;
                o.text = o.caseName;
                return true;
            });
            drawCaseInfoLayer(arr)
        },
        setWarnInfoArr: function (arr) {
            warnInfoArr = arr.filter(function (o, i) {
                o.id = i;
                o.dataId = o.warnId;
                o.text = o.warnTitle;
                return true;
            });
            drawWarnInfoLayer(arr)
        },
        updataTollgateArr: function () {
            getData()
        },
        updateCamera:function(arr){
            updateVideoArr(arr);
        },
        getMapSpatialReference:function () {
           return mapSatialReference;
        }
    }

}();

```