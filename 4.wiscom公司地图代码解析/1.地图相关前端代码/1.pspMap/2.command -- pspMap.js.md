command\pspMap

```js
/**
 * Created by lifeng on 2018/1/2.
 */
var pspMap = function () {

    dojo.require("esri.map");
    dojo.require("esri.config");
    dojo.require("esri.geometry.Point");
    dojo.require("esri.geometry.webMercatorUtils");
    dojo.require("esri.graphic");
    dojo.require("esri.layers.GraphicsLayer");
    dojo.require("esri.symbols.PictureMarkerSymbol");
    dojo.require("esri.symbols.SimpleMarkerSymbol");
    dojo.require("esri.Color");
    dojo.require("esri/dijit/OverviewMap");

    esri.config.defaults.io.corsDetection = true;
    esri.config.defaults.map.panDuration = 100;
    esri.config.defaults.map.panRate = 1;
    esri.config.defaults.map.zoomDuration = 100;
    esri.config.defaults.zoomRate = 1;

    var map = null;//地图对象
    var streetLayer = null;//地图底图
    var ImgLayer = null;
    var nightLayer = null;

    var tollgateclusterLayer = null;
    var videoclusterLayer = null;


    /*
     * 图层数组
     * [1,2,3,4]
     * 卡口，视频，案件，警情
     *
     * 卡口类型[78,79,80,81,82]
     *  WIFI探针卡口,人脸卡口,治安卡口  ,交通卡口,其他
     * */
    var tollgateLayer = null;//卡口图层
    var videoLayer = null;//视频图层
    var caseInfoLayer = null;//案件图层
    var warnInfoLayer = null;//警情图层

    var positioningLayer = null;//定位图层

    var whetherTheLoading = true;

    //地图页面汇点使用数据
    // 用于存储数据库查询到的卡口信息
    var tollgateArr = [];
    var videoArr = [];
    var caseInfoArr = [];
    var warnInfoArr = [];

    //返回页面的数据
    var businessTollgateArr = [];
    var businessCameraArr = [];
    var businessCaseInfoArr = [];
    var businessWarnInfoArr = [];

    //定位样式
    var arraySymbol = new esri.symbols.SimpleMarkerSymbol(
        {
            "color": new esri.Color([255, 0, 0]),
            "style": "Square",
            "type": "esriSMS",
            "xoffset": 0,
            "yoffset": 0
        }
    );

    var urlcenterPoint = "/systemManage/mapMaintain/initCenter";
    var urlcameraList = "/videoManage/camera/cameraList";
    // urltollgateList：数据库中卡口信息请求
    var urltollgateList = "/systemManage/tollgate/viewTollgateList";
    /*==============================================================*/
    var urlWarnInfoList = "/systemManage/warnInfo/warnInfoManage";
    var urlCaseInfoList = "/caseCenter/caseManage/getCaseInfoList";
    //测量地图使用的drawToolBar
    var measureTool = null;
    var measureHanlder = null;
    var drawToolBar = null;//地图toollbar
    var _cPoint = null;//加载完地图后的中心节点
    var _defaultZoomLevel = 12;//默认层级
    var currentPageObject;
    var drawEndHandler;
    var optionDefault={
        initCamera:true
    };
    /*==============================================================*/
    // 用于保存Layer参数中的json数据
    var displayTutzenData = {};
    var _initMap = function (mapElement, obj, Layer,option) {
        require(["esri/dijit/OverviewMap","extras/ClusterLayer",
                "dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
            "esri/renderers/ClassBreaksRenderer","esri/symbols/SimpleLineSymbol",
                "esri/Color","esri/geometry/webMercatorUtils"],
            function (OverviewMap,ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,SimpleLineSymbol,Color,webMercatorUtils) {
            map = new esri.map(mapElement, {
                // Booleean类型，是否自动调整大小，true：地图自动调整大小
                autoResize: true,
                logo: false,
                // Boolean类型，缩放时是否启用了淡入淡出效果
                fadeOnZoom: true,
                // Boolean类型，true：对于包含平铺地图服务图层的地图，确保将其捕捉到当前设置的范围。
                fitExtent: true,
                // Boolean类型，双击地图是否会放大范围
                isDoubleClickZoom: true
            });
            
            if(option){
                /* object2 合并到 object1 中 
               	   $.extend(object1, object2);
                */
                optionDefault = $.extend(optionDefault,option);
            }
            
        	// OverviewMap小部件在较大区域的上下文中显示地图的当前范围
            var overviewMapDijit = new esri.dijit.OverviewMap({
                map: map, // 必要的
                visible: true,    // 初始化可见，默认为false
                attachTo: "bottom-left", // 默认右上角
                width: 310,   // 默认值是地图高度的 1/4th
                height: 200, // 默认值是地图高度的 1/4th
                // opacity: 0.,  // 透明度 默认0.5
                maximizeButton: false, // 最大化,最小化按钮，默认false
                // expandFactor: 0.4,    //概览地图和总览图上显示的程度矩形的大小之间的比例。默认值是2，这意味着概览地图将至少是两倍的大小的程度矩形。
                // color: "red"  // 默认颜色为#000000
            });
            
            // 完成对OverviewMap dijit的创建
            overviewMapDijit.startup();
            drawToolBar = false;
            // 当前obj地址
            currentPageObject = obj;
            //初始化底图
            streetLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_SERVER_URL, {id: "streetLayer"});
            map.addLayer(streetLayer, 0);
            tollgateLayer = new esri.layers.GraphicsLayer({id: "tollgateLayer"});
            map.addLayer(tollgateLayer, 1);
            videoLayer = new esri.layers.GraphicsLayer({id: "videoLayer"});
            map.addLayer(videoLayer, 2);
            caseInfoLayer = new esri.layers.GraphicsLayer({id: "caseInfoLayer"});
            map.addLayer(caseInfoLayer, 3);
            warnInfoLayer = new esri.layers.GraphicsLayer({id: "warnInfoLayer"});
            map.addLayer(warnInfoLayer, 4);
            ImgLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_IMAGE_URL, {id: "ImgLayer"});
            map.addLayer(ImgLayer, 5);
            ImgLayer.setVisibility(false);
            nightLayer = new esri.layers.ArcGISTiledMapServiceLayer(ConfigSetting.MAP_NIGHT_URL, {id: "nightLayer"});
            map.addLayer(nightLayer, 6);
            nightLayer.setVisibility(false);
            displayTutzenData = Layer;
            getData();
            
            //初始化设置高度
            dojo.connect(map, "onZoomEnd", function (extent, zoomFactor, anchor) {
                var level = map.getLevel();
                if (level <= mapLevelAggregation) {
                    showPoint(false);
                } else {
                    showPoint(true);
                }
            });
            map.on("load", function () {
                var nowMap = this;
                nowMap.disableDoubleClickZoom();
                    //设置中心节点
                $.post(urlcenterPoint, function (data) {
                    if (data.state == "SUCCESS") {
                        if (data.rows.length > 0) {
                            var rowdata = data.rows[0];
                            var cPoint = new esri.geometry.Point(rowdata.longitude, rowdata.latitude);
                            nowMap.centerAndZoom(cPoint, rowdata.mapLevel);
                            _cPoint = cPoint;
                        }
                    }
                }, "json");
                if (showToolBar()) {
                    initToolBar(mapElement);
                    _initMapToolbar();
                }
            });

        })

        return map;
    };
    var showPoint = function (flag) {
        if (flag) {
            $("#LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                if(layerId == "videoLayer"){
                    if(videoclusterLayer !=null){
                        videoclusterLayer.setVisibility(false);
                    }
                }
                console.debug(layerId)
                if(layerId == "tollgateLayer"){
                    if(tollgateclusterLayer!=null){
                        tollgateclusterLayer.setVisibility(false);
                    }
                }
                layer.show();
            });


        } else {
            $("#LayerSearchContent .drawtoolDiv").find("input").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                layer.hide();
            });
            $("#LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                var layerId = $(this).attr("layerId");
                var layer = map.getLayer(layerId);
                if(layerId == "videoLayer"){
                    if(videoclusterLayer!=null){
                        videoclusterLayer.setVisibility(true);
                    }
                }
                if(layerId == "tollgateLayer"){
                    if(tollgateclusterLayer!=null){
                        tollgateclusterLayer.setVisibility(true);
                    }
                }
            });
    }
    };

    var cleraLayerForMap = function () {

    };
    var drawPictureLayerForMap = function () {
        if (tollgateArr.length > 0) {
            drawTollgateLayer(tollgateArr);
        }
        if (videoArr.length > 0) {
            drawVideoLayer(videoArr);
        }
    };

    //初始化地图工具栏
    var _initMapToolbar = function () {
        require(["esri/geometry/Point"], function (Point) {
            var index = 1;
            /*漫游*/
            $("#Pan").off().on("click", function () {
                //注销测距工具
                if (measureTool && !measureTool._destroyed) {
                    measureTool.destroy();
                    $("#measurePanel").hide();
                }
                //注销绘制工具
                if (drawToolBar) {
                    drawToolBar.deactivate();
                }
            });
            /*测距*/
            $("#Measure").click(function () {
                __startMeasure();
            });
            /*全图*/
            $("#FullExtent").click(function () {
                if (_cPoint != null) {
                    map.centerAndZoom(_cPoint, _defaultZoomLevel);
                }
            });
            /*影像*/
            $("#image").click(function () {
                var imageLayer = map.getLayer("ImgLayer");
                if (imageLayer) {
                    imageLayer.setVisibility(!imageLayer.visible);
                }
            });
            //绘制查询
            $("#rectTool,#polygonTool,#bufferTool,#lineTool,#clearTool").click(function (evt) {
                var id = $(this).attr("id");
                map.infoWindow.hide();
                switch (id) {
                    //矩形
                    case "rectTool":
                        __mapDrawSearch("Rectangle");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //多边形
                    case "polygonTool":
                        __mapDrawSearch("Polygon");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //圆形
                    case "bufferTool":
                        __mapDrawSearch("Circle");
                        $(this).parent(".toolH").addClass("selected").siblings().removeClass("selected");
                        break;
                    //清除
                    case "clearTool":
                        //清空绘制图层数据
                        var drawLayer = map.getLayer("drawLayer");
                        $(this).parent(".toolH").siblings().removeClass("selected");
                        if (drawLayer) {
                            drawLayer.clear();
                            $("#bayonetresults").hide();
                        }
                        businessTollgateArr = [];
                        businessCameraArr = [];
                        businessCaseInfoArr = [];
                        businessWarnInfoArr = [];
                        if (currentPageObject.getDrawHandlerResult && typeof(currentPageObject.getDrawHandlerResult) == "function") {
                            currentPageObject.getDrawHandlerResult(businessTollgateArr, businessCameraArr, businessCaseInfoArr, businessWarnInfoArr,true)
                        }
                        // if (currentPageObject.getclearTool && typeof(currentPageObject.getclearTool) == "function") {
                        //     currentPageObject.getclearTool()
                        // }
                        //注销测距工具
                        if (measureTool && !measureTool._destroyed) {
                            measureTool.destroy();
                            $("#measurePanel").hide();
                            $("#measurePanel").hide().html("");
                        }
                        //注销绘制工具
                        if (drawToolBar) {
                            drawToolBar.deactivate();
                        }
                        /*清除已选卡口*/
                        break;
                    default:
                        break;
                }

            });

            /*工具条下拉*/
            $("#DrawSearchBtn").click(function (e) {
                e.stopPropagation();
                $(this).parent().parent().siblings().find(".extentTools").hide();
                $(this).parent().parent().siblings().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                $(this).parent().find(".extentTools").toggle();
                if ($(this).parent().find(".toolexpand").attr("src") == "/images/map/toolbar/down.png") {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/up.png");
                }
                else {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                }
                //点击页面其他位置收起工具条下拉
                $(document).click(function () {
                    $(".toolexpand").each(function () {
                        if ($(this).attr("src") == "/images/map/toolbar/up.png") {
                            $(this).parent().click();
                        }
                    });
                });
            });
            /*图层下拉*/
            $("#LayerSearch").click(function (e) {
                e.stopPropagation();
                $(this).parent().parent().siblings().find(".extentTools").hide();
                $(this).parent().parent().siblings().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                $(this).parent().find(".extentTools").toggle();
                if ($(this).parent().find(".toolexpand").attr("src") == "/images/map/toolbar/down.png") {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/up.png");
                }
                else {
                    $(this).parent().find(".toolexpand").attr("src", "/images/map/toolbar/down.png");
                }
                //点击页面其他位置收起工具条下拉
                $(document).click(function () {
                    $(".toolexpand").each(function () {
                        if ($(this).attr("src") == "/images/map/toolbar/up.png") {
                            $(this).parent().click();
                        }
                    });
                });
            });
            $("#LayerSearchContent").off().on("click", function (e) {
                e.stopPropagation();
            });
            $("input[name='checkbox']").change(function (e) {
                var layerId = $(this).attr("layerId");
                var flag = this.checked;
                changeLayer(layerId, flag);
            })

        });
    };
    /*显示隐藏图层*/
    function changeLayer(layerId, flag) {
        var layer = map.getLayer(layerId);
        if (flag) {
            layer.show();
        } else {
            layer.hide();
        }
    }

    //end 轨迹
    var __startMeasure = function () {
        require(["esri/geometry/Polyline", "esri/geometry/Point", "esri/dijit/Measurement", "esri/units"],
            function (Polyline, Point, Measurement, units) {
                var customPolyline = new Polyline();
                customPolyline.addPath([
                    new Point(0, 0),
                    new Point(0, 0),
                    new Point(0, 0)
                ]);
                if (!measureTool || measureTool._destroyed) {
                    measureTool = Measurement({
                        map: map,
                        geometry: customPolyline,
                        defaultLengthUnit: units.METERS
                    });
                }
                if (measureHanlder) {
                    measureHanlder.remove();
                }
                measureTool.startup();
                $("#measurePanel").show();
                measureHanlder = measureTool.on("measure", function (evt) {
                    var result = evt.values;
                    $("#measurePanel").text("距离：" + result.toFixed(2) + "米");
                });
            });
    };
    //地图图形查询
    var __mapDrawSearch = function (geometryType) {
        require(["esri/toolbars/draw", "esri/graphic", "esri/symbols/SimpleFillSymbol", "esri/symbols/SimpleLineSymbol",
                "esri/layers/GraphicsLayer", "esri/Color", "esri/geometry/webMercatorUtils", "esri/tasks/query",
                "esri/tasks/QueryTask", "esri/tasks/IdentifyTask", "esri/tasks/IdentifyParameters"],
            function (Draw, Graphic, SimpleFillSymbol, SimpleLineSymbol, GraphicsLayer, Color, webMercatorUtils, Query, QueryTask, IdentifyTask, IdentifyParameters) {
                //每次绘制前，清空已绘制图形
                var drawLayer = map.getLayer("drawLayer");
                if (drawLayer) {
                    drawLayer.clear();
                    $("#bayonetresults").hide();
                    $(".toolH").removeClass("selected");
                } else {
                    drawLayer = new GraphicsLayer({"id": "drawLayer"});
                    map.addLayer(drawLayer);
                }

                //防止开始绘制前多次绑定绘制完成的方法
                if (drawEndHandler) {
                    dojo.disconnect(drawEndHandler);
                }
                //防止开始绘制前多次初始化绘制工具
                if (drawToolBar) {
                    drawToolBar.deactivate();
                }
                else {
                    drawToolBar = new Draw(map);
                }
                switch (geometryType) {
                    case "Rectangle":
                        drawToolBar.activate(esri.toolbars.Draw.RECTANGLE);
                        break;
                    case "Polygon":
                        drawToolBar.activate(esri.toolbars.Draw.POLYGON);
                        break;
                    case "Circle":
                        drawToolBar.activate(esri.toolbars.Draw.CIRCLE);
                        break;
                    case "Polyline":
                        drawToolBar.activate(esri.toolbars.Draw.POLYLINE);
                        break;
                    default:
                        break;
                }
                drawEndHandler = dojo.connect(drawToolBar, "onDrawEnd", function (geometry) {
                    dojo.disconnect(drawEndHandler);
                    //清除选中状态 清除地图圈选范围
                    $(".toolH").siblings().removeClass("selected");
                    //清空数据
                    businessTollgateArr = [];
                    businessCameraArr = [];
                    businessCaseInfoArr = [];
                    businessWarnInfoArr = [];
                    var symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT, new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.25]));
                    var graphic = new Graphic(geometry, symbol);
                    drawLayer.add(graphic);
                    drawToolBar.deactivate();
                    var selectArr = [];
                    $("#LayerSearchContent .drawtoolDiv").find("input:checked").each(function () {
                        var layerId = $(this).attr("layerId");
                        var layer = map.getLayer(layerId);
                        if (layer.visible) {
                            for (var i = 0, c = layer.graphics.length; i < c; i++) {
                                var p = webMercatorUtils.geographicToWebMercator(layer.graphics[i].geometry);
                                if (geometry.contains(p)) {
                                    selectArr.push(layer.graphics[i]);
                                }
                            }
                        }
                    });
                    for (var i = 0; i < selectArr.length; i++) {
                        if (selectArr[i].attributes.species == "tollgate") {
                            businessTollgateArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "camera") {
                            businessCameraArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "caseInfo") {
                            businessCaseInfoArr.push(selectArr[i])
                        }
                        if (selectArr[i].attributes.species == "warnInfo") {
                            businessWarnInfoArr.push(selectArr[i])
                        }
                    }
                    if (currentPageObject.getDrawHandlerResult && typeof(currentPageObject.getDrawHandlerResult) == "function") {
                        currentPageObject.getDrawHandlerResult(businessTollgateArr, businessCameraArr, businessCaseInfoArr, businessWarnInfoArr)
                    }
                });
            });
    };
    var clearDraw = function () {

    };

    function getData() {
        // esri/geometry/webMercatorUtils: 将webMercator坐标转化为地理坐标
        require(["esri/dijit/OverviewMap","extras/ClusterLayer",
                "dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
                "esri/renderers/ClassBreaksRenderer","esri/symbols/SimpleLineSymbol",
                "esri/Color","esri/geometry/webMercatorUtils"],
            function (OverviewMap,ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,SimpleLineSymbol,Color,webMercatorUtils) {
                if (displayTutzenData.tollgate.length > 0) {
                    // join(","):将数组中的数据统一用","分割
                    // urltollgateList：请求数据库中的卡口信息
                    $.post(urltollgateList, {tollgateType: displayTutzenData.tollgate.join(",")}, function (tollgateData) {
                        tollgateArr = [];
                        if (tollgateData && tollgateData.state == "SUCCESS") {
                            // 使用tollgateList存储返回的数据，返回的数据类型为Array
                            var tollgateList = tollgateData.rows;
                            // 对返回的数据进行过滤
                            // filter(function (element, index, self)
                            // >> element: 表示Array的某个元素
                            // >> index: 表示元素的位置
                            // >> self: 表示数组本生
                            tollgateArr = tollgateList.filter(function (o, i) {
                                o.id = i;
                                o.dataId = o.tollgateId;
                                o.text = o.tollgateName;
                                o.x = o.longitude;
                                o.y = o.latitude;
                                o.name = o.tollgateName;
                                o.attributes =  {
                                    "x":o.longitude,
                                    "y":o.latitude,
                                    "name":o.tollgateName
                                };
                                return true;
                            });
                            var countyInfo = {};
                            // arrayUtils.map():遍历处理tollgateArr数组中的每一条数据
                            countyInfo.data = arrayUtils.map(tollgateArr, function(item) {
                                // new Point(x, y, spatialReference)
                                // >> 由x，y坐标定义地图位置;spatialReference：地图的空间参考
                                var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                                // 将几何图形从地理单位转换为Web墨卡托单位
                                var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                                var attributes = {
                                    "名称": item.name,
                                    "经度": item.x,
                                    "纬度": item.y
                                };
                                return {
                                    "x": webMercator.x,
                                    "y": webMercator.y,
                                    "attributes": attributes
                                };
                            });
                            
                            tollgateclusterLayer = new ClusterLayer({
                                "data": countyInfo.data,
                                "distance": 150,
                                "id": "clusterstollgate",
                                "labelColor": "#000",
                                "labelOffset": 10,
                                "resolution": map.extent.getWidth() / map.width,
                                "spatialReference":mapSatialReference,
                            });
                            var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                            var blue = new esri.symbols.PictureMarkerSymbol("/images/icons/gisTollgateTraffic.png", 26, 34).setOffset(0, 15);
                             renderer.addBreak(0, tollgateArr.length, blue);
                             tollgateclusterLayer.setRenderer(renderer);
                            map.addLayer(tollgateclusterLayer);
                            drawTollgateLayer(tollgateArr);
                        }
                    }, "json");
                }
                if (displayTutzenData.video&&optionDefault.initCamera) {
                    $.post(urlcameraList, function (tollgateData) {
                        videoArr = [];
                        if (tollgateData && tollgateData.state == "SUCCESS") {
                            var tollgateList = tollgateData.rows;
                            videoArr = tollgateList.filter(function (o, i) {
                                o.id = i;
                                o.dataId = o.cameraId;
                                o.text = o.cameraName;
                                o.x = o.longitude;
                                o.y = o.latitude;
                                o.name = o.cameraName;
                                o.attributes =  {
                                    "x":o.longitude,
                                    "y":o.latitude,
                                    "name":o.cameraName
                                };
                                return true;
                            });
                            var countyInfoVideo = {};
                            countyInfoVideo.data = arrayUtils.map(videoArr, function(item) {
                                var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                                var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                                var attributes = {
                                    "名称": item.name,
                                    "经度": item.x,
                                    "纬度": item.y
                                };
                                return {
                                    "x": webMercator.x,
                                    "y": webMercator.y,
                                    "attributes": attributes
                                };
                            });
                            videoclusterLayer = new ClusterLayer({
                                "data": countyInfoVideo.data,
                                "distance": 150,
                                "id": "clustersvideo",
                                "labelColor": "#000",
                                "labelOffset": 10,
                                "resolution": map.extent.getWidth() / map.width,
                                "spatialReference":mapSatialReference,
                                // "singleColor": "#f00",
                                // "maxSingles":3000
                            });
                            var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                            var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                            var green = new esri.symbols.PictureMarkerSymbol("/images/icons/shootingGis.png", 26, 34).setOffset(0, 15);
                            renderer.addBreak(0, videoArr.length, green);
                            videoclusterLayer.setRenderer(renderer);
                            map.addLayer(videoclusterLayer);
                            drawVideoLayer(videoArr);
                        }
                    }, "json");
                }
                // if (displayTutzenData.warnInfo) {
                //     $.post(urlWarnInfoList, function (tollgateData) {
                //         warnInfoArr = [];
                //         if (tollgateData && tollgateData.state == "SUCCESS") {
                //             var alarmList = tollgateData.rows;
                //             for (j  in alarmList) {
                //                 warnInfoArr.push({
                //                     dataId: alarmList[j].warnId,
                //                     text: alarmList[j].warnTitle,
                //                 });
                //             }
                //             warnInfoArr = warnInfoArr.filter(function (o, i) {
                //                 o.id = i;
                //                 return true;
                //             });
                //         }
                //     }, "json");
                // }
                // if (displayTutzenData.case) {
                //     $.post(urlCaseInfoList, function (tollgateData) {
                //         caseInfoArr = [];
                //         if (tollgateData && tollgateData.state == "SUCCESS") {
                //             var tollgateList = tollgateData.rows;
                //             caseInfoArr = tollgateList.filter(function (o, i) {
                //                 o.id = i;
                //                 o.dataId = o.caseId;
                //                 o.text = o.caseName;
                //                 return true;
                //             });
                //         }
                //     }, "json");
                // }
        })



    }

    function initToolBar(mapEl) {
        $("#" + mapEl).append($("#mapToolbar").html());
        if (displayTutzenData.tollgate.length == 0) {
            $("#selDivPan .showcasing.tollgate").remove();
            $("#LayerSearchContent .drawtoolDiv.tollgate").remove();
        }
        if (!displayTutzenData.video) {
            $("#selDivPan .showcasing.video").remove();
            $("#LayerSearchContent .drawtoolDiv.video").remove();
        }
        if (!displayTutzenData.case) {
            $("#selDivPan .showcasing.case").remove();
            $("#LayerSearchContent .drawtoolDiv.caseInfo").remove();
        }
        if (!displayTutzenData.warnInfo) {
            $("#selDivPan .showcasing.alarm").remove();
            $("#LayerSearchContent .drawtoolDiv.warnInfo").remove();
        }
        $("#mapLocate").off().on("click", function () {
            if ($(".card").hasClass("animated-card")) {
                $("#selHidden").hide();
                $(".selected").removeClass("selectedSel2");
                $(".card").removeClass("animated-card");
            } else {
                $(".card").addClass("animated-card");
                $(".showcasing").removeClass("selectedSel2");
            }
        });
        $(".showcasing").off().on("click", function () {
            if ($(this).hasClass("selectedSel2")) {
                $("#selHidden").hide();
                $(this).removeClass("selectedSel2");
            } else {
                $(".showcasing").removeClass("selectedSel2");
                $("#selHidden").show();
                $(this).addClass("selectedSel2");
                if ($(this).hasClass("tollgate")) {
                    bindData("卡口", tollgateArr);
                }
                if ($(this).hasClass("video")) {
                    bindData("视频", videoArr);
                }
                if ($(this).hasClass("case")) {
                    bindData("案件", caseInfoArr);
                }
                if ($(this).hasClass("alarm")) {
                    bindData("警情", warnInfoArr);
                }
            }
        });
    }

    function bindData(text, dataArr) {
        $("#selTollgate").empty();
        $("#selTollgate").select2({
            placeholder: "请输入" + text + "名称",
            allowClear: true,
            multiple: false,
            data: dataArr,
            width: null
        }).val(null).trigger("change").off().on("change", function () {
            var val = $("#selTollgate").val();
            if (val == null) {
                return;
            }
            if (positioningLayer != null) {
                positioningLayer.clear();
            } else {
                positioningLayer = new esri.layers.GraphicsLayer({id: "positioningLayer"});
                map.addLayer(positioningLayer);
            }
            if (dataArr[val].longitude != 0 && dataArr[val].longitude != '' && dataArr[val].longitude != null) {
                var cPoint = new esri.geometry.Point(dataArr[val].longitude, dataArr[val].latitude);
                var alarm_g = new esri.Graphic(cPoint);
                alarm_g.setSymbol(arraySymbol);
                positioningLayer.add(alarm_g);
                map.centerAt(cPoint);
                $(positioningLayer.getNode()).animate({opacity: 0}, 600).animate({opacity: 0.8}, 600).animate({opacity: 0}, 600).animate({opacity: 1}, 600, function () {
                    positioningLayer.clear();
                })
                if (currentPageObject.accessToLocate && typeof(currentPageObject.accessToLocate) == "function") {
                    currentPageObject.accessToLocate(dataArr[val])
                }
            } else {
                common.showWarn("点位坐标未配置", "提示")
            }


        });
    }

    function showToolBar() {
        var flag = false;
        if (displayTutzenData.tollgate.length > 0 || displayTutzenData.video || displayTutzenData.warnInfo || displayTutzenData.case) {
            flag = true;
        }
        return flag;
    }

    var drawTollgateLayer = function (data) {
        if (tollgateLayer) {
            tollgateLayer.clear();
        }
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longitude;
            var alarm_y = data[i].latitude;
            var alarm_type = data[i].tollgateType;
            var alarm_attr = {
                "name": data[i].tollgateName,
                "id": data[i].tollgateId,
                "type": data[i].tollgateType,
                "species": "tollgate",
                "longitude": data[i].longitude,
                "latitude": data[i].latitude,
                "states": ""
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y));
            if (alarm_type == 78) {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/gisWifi.png", 26, 34));
            }
            if (alarm_type == 79) {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/gisFace.png", 26, 34));
            }
            if (alarm_type == 80) {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/gis80.png", 26, 34));
            }
            if (alarm_type == 81) {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/gisTollgateTraffic.png", 26, 34));
            }
            if (alarm_type == 82) {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/otherTollgate.png", 26, 34));
            }
            tollgateLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }
    };
    var drawVideoLayer = function (data) {
        if (videoLayer) {
            videoLayer.clear();
        }
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longitude;
            var alarm_y = data[i].latitude;
            var alarm_states = data[i].status;
            var alarm_type = data[i].cameraType;
            var alarm_attr = {
                "name": data[i].cameraName,
                "id": data[i].cameraId,
                "type": data[i].cameraType,
                "species": "camera",
                "longitude": data[i].longitude,
                "latitude": data[i].latitude,
                "states": data[i].status,
                "playCtrl":data[i].playControl
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y));
            if (alarm_states == "0" && alarm_type == "1") {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/shootingGis.png", 26, 34));
            }
            if (alarm_states == "1" && alarm_type == "1") {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/shootingFailureGis.png", 26, 34));
            }
            if (alarm_states == "0" && alarm_type == "2") {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/skillGis.png", 26, 34));
            }
            if (alarm_states == "1" && alarm_type == "2") {
                alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/skillFailureGis.png", 26, 34));
            }
            videoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }
    };
    var drawCaseInfoLayer = function (data) {

        if (caseInfoLayer != null) {
            caseInfoLayer.clear();
        }
        ;
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longitude;
            var alarm_y = data[i].latitude;
            var alarm_attr = {
                "name": data[i].caseName,
                "id": data[i].caseNo,
                "type": "",
                "species": "caseInfo",
                "longitude": data[i].longitude,
                "latitude": data[i].latitude,
                "states": "",
                "time": data[i].startTime
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y));
            alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/caseGis.png", 20, 20));
            caseInfoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }

    };
    var drawWarnInfoLayer = function (data) {
        if (warnInfoLayer != null) {
            warnInfoLayer.clear();
        }
        ;
        for (var i = 0; i < data.length; i++) {
            var alarm_x = data[i].longtitude;
            var alarm_y = data[i].latitude;
            var alarm_attr = {
                "name": data[i].warnTitle,
                "id": data[i].warnId,
                "species": "warnInfo",
                "longitude": data[i].longtitude,
                "latitude": data[i].latitude,
                "states": "",
                "time": data[i].warnTime
            };
            var alarm_g = new esri.Graphic(new esri.geometry.Point(alarm_x, alarm_y));
            alarm_g.setSymbol(new esri.symbols.PictureMarkerSymbol("/images/icons/alarmLocation.png", 20, 20));
            warnInfoLayer.add(alarm_g);
            alarm_g.setAttributes(alarm_attr);
        }
    };
    var updateVideoArr = function(arr){
        require(["extras/ClusterLayer","dojo/_base/array","esri/geometry/Point","esri/symbols/SimpleMarkerSymbol",
                "esri/renderers/ClassBreaksRenderer","esri/geometry/webMercatorUtils"],
            function (ClusterLayer,arrayUtils,Point,SimpleMarkerSymbol,
                      ClassBreaksRenderer,webMercatorUtils) {
                debugger;
                videoArr = arr.filter(function (o, i) {
                    o.id = i;
                    o.dataId = o.tollgateId;
                    o.text = o.fileUri;
                    o.x = o.longitude;
                    o.y = o.latitude;
                    o.name = o.dealText;
                    o.attributes = {
                        "x": o.longitude,
                        "y": o.latitude,
                        "name": o.dealText
                    };
                    return true;
                });
                var countyInfoVideo = {};
                countyInfoVideo.data = arrayUtils.map(videoArr, function (item) {
                    var latlng = new Point(parseFloat(item.x), parseFloat(item.y), map.spatialReference);
                    var webMercator = webMercatorUtils.geographicToWebMercator(latlng);
                    var attributes = {
                        "名称": item.name,
                        "经度": item.x,
                        "纬度": item.y
                    };
                    return {
                        "x": webMercator.x,
                        "y": webMercator.y,
                        "attributes": attributes
                    };
                });
                videoclusterLayer = new ClusterLayer({
                    "data": countyInfoVideo.data,
                    "distance": 150,
                    "id": "clustersvideo",
                    "labelColor": "#000",
                    "labelOffset": 10,
                    "resolution": map.extent.getWidth() / map.width,
                    "spatialReference":mapSatialReference,
                    // "singleColor": "#f00",
                    // "maxSingles":3000
                });
                var defaultSym = new esri.symbols.SimpleMarkerSymbol().setSize(1);
                var renderer = new ClassBreaksRenderer(defaultSym, "clusterCount");
                var green = new esri.symbols.PictureMarkerSymbol("/images/icons/shootingGis.png", 26, 34).setOffset(0, 15);
                renderer.addBreak(0, videoArr.length, green);
                videoclusterLayer.setRenderer(renderer);
                map.addLayer(videoclusterLayer);
                drawVideoLayer(videoArr);
            })
    }
    return {
        init: function (mapElement, obj, Layer,option) {
            // console.debug("调试地图功能");
            return _initMap(mapElement, obj, Layer,option);
        },
        getMap: function () {
            return map;
        },
        setCaseInfoArr: function (arr) {
            caseInfoArr = arr.filter(function (o, i) {
                o.id = i;
                o.dataId = o.caseId;
                o.text = o.caseName;
                return true;
            });
            drawCaseInfoLayer(arr)
        },
        setWarnInfoArr: function (arr) {
            warnInfoArr = arr.filter(function (o, i) {
                o.id = i;
                o.dataId = o.warnId;
                o.text = o.warnTitle;
                return true;
            });
            drawWarnInfoLayer(arr)
        },
        updataTollgateArr: function () {
            getData()
        },
        updateCamera:function(arr){
            updateVideoArr(arr);
        }
    }

}();

```